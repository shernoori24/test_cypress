name: App Plania Tests
run-name: ${{ github.actor }} is running Cypress tests on App Plania 
on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4
      
      - name:  Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name:  Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name:  Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì¶ Install Cypress dependencies
        run: |
          npm install
          
      - name: üèÉ‚Äç‚ôÇÔ∏è Start Flask application
        run: |
          python main.py &
          sleep 10  # Attendre que l'app d√©marre
        env:
          FLASK_ENV: testing
          
      - name:  Wait for application to be ready
        run: |
          timeout 30s bash -c 'until curl -f http://localhost:5555; do sleep 2; done'
          
      - name:  Run Cypress tests
        run: |
          npx cypress run --headless --browser chrome
        env:
          CYPRESS_baseUrl: http://localhost:5555
          
      - name:  Upload Cypress screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          
      - name:  Upload Cypress videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
