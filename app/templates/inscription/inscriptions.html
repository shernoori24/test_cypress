<!-- app/templates/inscription/inscriptions.html -->
{% extends "base.html" %}
{% block title %}Inscriptions{% endblock %}
{% block body %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Inscriptions</h2>
            <div>
                <a href="{{ url_for('inscription.inserer_inscription') }}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Nouvelle inscription
                </a>
                
            </div>
        </div>

        <!-- Statistiques rapides -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>{{ total_inscriptions }}</h3>
                        <p class="mb-0">Total inscriptions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>{{ inscriptions_mois }}</h3>
                        <p class="mb-0">Ce mois-ci</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3>{{ inscriptions_semaine }}</h3>
                        <p class="mb-0">Cette semaine</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <h3>{{ inscriptions_jour }}</h3>
                        <p class="mb-0">Aujourd'hui</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filtres</h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row" id="filterForm">
                    <!-- Première ligne : Recherche, Sexe, Ville, Prioritaire -->
                    <div class="col-md-3">
                        <label for="search" class="form-label">Recherche (nom/prénom)</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ request.args.get('search', '') }}" placeholder="Nom / Prénom / n°">
                    </div>
                    <div class="col-md-2">
                        <label for="sexe" class="form-label">Sexe</label>
                        <select class="form-control" id="sexe" name="sexe">
                            <option value="">Tous</option>
                            <option value="M" {% if request.args.get('sexe') == 'M' %}selected{% endif %}>Masculin</option>
                            <option value="F" {% if request.args.get('sexe') == 'F' %}selected{% endif %}>Féminin</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="ville" class="form-label">Ville</label>
                        <select class="form-control" id="ville" name="ville">
                            <option value="">Toutes</option>
                            {% for ville in villes %}
                            <option value="{{ ville }}" {% if request.args.get('ville') == ville %}selected{% endif %}>{{ ville }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="prioritaire" class="form-label">Prioritaire</label>
                        <select class="form-control" id="prioritaire" name="prioritaire">
                            <option value="">Tous</option>
                            <option value="oui" {% if request.args.get('prioritaire') == 'oui' %}selected{% endif %}>Oui</option>
                            <option value="non" {% if request.args.get('prioritaire') == 'non' %}selected{% endif %}>Non</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <!-- Espace vide pour aligner les boutons à droite plus tard -->
                    </div>
                    
                    <!-- Deuxième ligne : Dates et filtres -->
                    <div class="col-md-2 mt-3">
                        <label for="date_debut" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Date inscription - Début
                        </label>
                        <input type="date" class="form-control" id="date_debut" name="date_debut" 
                               value="{{ request.args.get('date_debut', '') }}">
                    </div>
                    <div class="col-md-2 mt-3">
                        <label for="date_fin" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Date inscription - Fin
                        </label>
                        <input type="date" class="form-control" id="date_fin" name="date_fin" 
                               value="{{ request.args.get('date_fin', '') }}">
                    </div>
                    <div class="col-md-2 mt-3">
                        <label for="pays_naissance" class="form-label">
                            <i class="fas fa-globe"></i> Pays de naissance
                        </label>
                        <select class="form-control" id="pays_naissance" name="pays_naissance">
                            <option value="">Tous les pays</option>
                            {% for pays in pays %}
                            <option value="{{ pays }}" {% if request.args.get('pays_naissance') == pays %}selected{% endif %}>{{ pays }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mt-3">
                        <label for="prescripteur" class="form-label">
                            <i class="fas fa-user-tie"></i> Prescripteur
                        </label>
                        <select class="form-control" id="prescripteur" name="prescripteur">
                            <option value="">Tous</option>
                            {% for prescripteur in prescripteurs %}
                            <option value="{{ prescripteur }}" {% if request.args.get('prescripteur') == prescripteur %}selected{% endif %}>{{ prescripteur }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mt-3">
                        <label for="structure_actuelle" class="form-label">
                            <i class="fas fa-building"></i> Structure actuelle
                        </label>
                        <select class="form-control" id="structure_actuelle" name="structure_actuelle">
                            <option value="">Toutes</option>
                            {% for structure in structures %}
                            <option value="{{ structure }}" {% if request.args.get('structure_actuelle') == structure %}selected{% endif %}>{{ structure }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Troisième ligne : Anniversaires, Années de naissance et boutons -->
                    <div class="col-md-3 mt-3">
                        <label for="mois_anniversaire" class="form-label">
                            <i class="fas fa-gift"></i> Anniversaires
                        </label>
                        <select class="form-control" id="mois_anniversaire" name="mois_anniversaire">
                            <option value="">Tous</option>
                            <option value="ce_mois" {% if request.args.get('mois_anniversaire') == 'ce_mois' %}selected{% endif %}>Ce mois (Août)</option>
                            <option value="01" {% if request.args.get('mois_anniversaire') == '01' %}selected{% endif %}>Janvier</option>
                            <option value="02" {% if request.args.get('mois_anniversaire') == '02' %}selected{% endif %}>Février</option>
                            <option value="03" {% if request.args.get('mois_anniversaire') == '03' %}selected{% endif %}>Mars</option>
                            <option value="04" {% if request.args.get('mois_anniversaire') == '04' %}selected{% endif %}>Avril</option>
                            <option value="05" {% if request.args.get('mois_anniversaire') == '05' %}selected{% endif %}>Mai</option>
                            <option value="06" {% if request.args.get('mois_anniversaire') == '06' %}selected{% endif %}>Juin</option>
                            <option value="07" {% if request.args.get('mois_anniversaire') == '07' %}selected{% endif %}>Juillet</option>
                            <option value="08" {% if request.args.get('mois_anniversaire') == '08' %}selected{% endif %}>Août</option>
                            <option value="09" {% if request.args.get('mois_anniversaire') == '09' %}selected{% endif %}>Septembre</option>
                            <option value="10" {% if request.args.get('mois_anniversaire') == '10' %}selected{% endif %}>Octobre</option>
                            <option value="11" {% if request.args.get('mois_anniversaire') == '11' %}selected{% endif %}>Novembre</option>
                            <option value="12" {% if request.args.get('mois_anniversaire') == '12' %}selected{% endif %}>Décembre</option>
                        </select>
                    </div>
                    <div class="col-md-2 mt-3">
                        <label for="annee_min" class="form-label">
                            <i class="fas fa-baby"></i> Année min
                        </label>
                        <input type="number" class="form-control" id="annee_min" name="annee_min" 
                               value="{{ request.args.get('annee_min', '') }}" 
                               min="{{ birth_years_range.min_year }}" 
                               max="{{ birth_years_range.max_year }}"
                               placeholder="Ex: {{ birth_years_range.min_year }}">
                    </div>
                    <div class="col-md-2 mt-3">
                        <label for="annee_max" class="form-label">
                            <i class="fas fa-baby"></i> Année max
                        </label>
                        <input type="number" class="form-control" id="annee_max" name="annee_max" 
                               value="{{ request.args.get('annee_max', '') }}" 
                               min="{{ birth_years_range.min_year }}" 
                               max="{{ birth_years_range.max_year }}"
                               placeholder="Ex: {{ birth_years_range.max_year }}">
                    </div>
                    <div class="col-md-5 mt-3 d-flex align-items-end justify-content-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> Filtrer
                        </button>
                        <a href="{{ url_for('inscription.voir_inscriptions') }}" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tableau des inscriptions -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table"></i> Inscriptions ({{ inscriptions|length if inscriptions else 0 }} résultats)</h5>
                
                <!-- Indicateurs de filtres actifs -->
                {% set filters_active = [] %}
                {% if request.args.get('search') %}{{ filters_active.append('recherche') or '' }}{% endif %}
                {% if request.args.get('sexe') %}{{ filters_active.append('sexe') or '' }}{% endif %}
                {% if request.args.get('ville') %}{{ filters_active.append('ville') or '' }}{% endif %}
                {% if request.args.get('prioritaire') %}{{ filters_active.append('prioritaire') or '' }}{% endif %}
                {% if request.args.get('pays_naissance') %}{{ filters_active.append('pays') or '' }}{% endif %}
                {% if request.args.get('date_debut') or request.args.get('date_fin') %}{{ filters_active.append('dates') or '' }}{% endif %}
                
                {% if filters_active %}
                <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2">
                        <i class="fas fa-filter"></i> {{ filters_active|length }} filtre(s) actif(s)
                    </span>
                    {% if request.args.get('date_debut') %}
                        <span class="badge bg-success me-1">Du: {{ request.args.get('date_debut') }}</span>
                    {% endif %}
                    {% if request.args.get('date_fin') %}
                        <span class="badge bg-success me-1">Au: {{ request.args.get('date_fin') }}</span>
                    {% endif %}
                    {% if request.args.get('pays_naissance') %}
                        <span class="badge bg-warning me-1">Pays: {{ request.args.get('pays_naissance') }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if inscriptions %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Photo</th>
                                <th>N°</th>
                                <th>Nom</th>
                                <th>Prénom</th>
                                <th>Sexe</th>
                                <th>Âge</th>
                                <th>Ville</th>
                                <th>Pays de naissance</th>
                                <th>Téléphone</th>
                                <th>Email</th>
                                <th>Date inscription</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for inscription in inscriptions %}
                            <tr onclick="voirDetails('{{ inscription['N°'] }}', event)" style="cursor: pointer;">
                                <td>
                                    <img src="/photos_profils_apprenants/{{ inscription['N°'] }}.jpg"
                                         alt="Photo {{ inscription['N°'] }}"
                                         class="rounded-circle"
                                         style="width: 40px; height: 40px; object-fit: cover; border: 2px solid #dee2e6;"
                                         width="40" height="40"
                                         loading="lazy" decoding="async"
                                         onerror="this.onerror=null;this.src='/photos_profils_apprenants/{{ inscription['N°'] }}.jpeg';this.onerror=function(){this.src='/photos_profils_apprenants/defaut_profil.jpg'};">
                                </td>
                                <td><span class="badge bg-primary">{{ inscription['N°'] }}</span></td>
                                <td><strong>{{ inscription['NOM'] }}</strong></td>
                                <td>{{ inscription['Prénom'] }}</td>
                                <td>
                                    {% if inscription['Sexe'] == 'M' %}
                                        <span class="badge bg-info">M</span>
                                    {% elif inscription['Sexe'] == 'F' %}
                                        <span class="badge bg-warning">F</span>
                                    {% elif inscription['Sexe'] == 'Autre' %}
                                        <span class="badge bg-warning text-dark">Autre</span>
                                    {% else %}
                                        <span class="badge bg-secondary">?</span>
                                    {% endif %}
                                </td>
                                <td>{{ inscription['Age'] if inscription['Age'] else '-' }}</td>
                                <td>{{ inscription['Ville'] }}</td>
                                <td>
                                    {% if inscription['Pays de naissance'] %}
                                        <span class="badge bg-light text-dark">{{ inscription['Pays de naissance'] }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inscription['Téléphone'] %}
                                        <a href="tel:{{ inscription['Téléphone'] }}">{{ inscription['Téléphone'] }}</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inscription['Email'] %}
                                        <a href="mailto:{{ inscription['Email'] }}">{{ inscription['Email'] }}</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>

                                <td>{{ inscription['Date inscription'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>Aucune inscription trouvée</h5>
                    <p class="text-muted">Aucune inscription ne correspond aux critères de recherche.</p>
                    <a href="{{ url_for('inscription.inserer_inscription') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Ajouter une inscription
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails de l'inscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Contenu chargé dynamiquement -->
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher les détails -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">
                    <i class="fas fa-user"></i> Détails de l'inscription
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p>Chargement des détails...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/inscription.js') }}"></script>

{% endblock %}
