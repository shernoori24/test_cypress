{% extends "base.html" %}
{% block title %}Pointage Pr√©sences{% endblock %}

{% block body %}
<style>
.atelier-card {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.atelier-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.atelier-card.active {
    border-color: #007bff;
    background-color: #e7f3ff;
}

.apprenant-item {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin: 3px 0;
    cursor: pointer;
}

.apprenant-item:hover {
    background-color: #f8f9fa;
}

.apprenant-item.present {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.apprenant-item.absent {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.apprenant-info {
    line-height: 1.2;
}

.apprenant-prenom {
    color: #007bff;
    font-size: 1rem;
}

.apprenant-nom {
    color: #495057;
    font-size: 1rem;
    margin-left: 6px;
}

.apprenant-item .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 10px;
}

.status-present {
    background-color: #28a745;
}

.status-absent {
    background-color: #dc3545;
}

.status-pending {
    background-color: #ffc107;
}

.filtre-heure {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    margin: 2px;
    transition: all 0.3s ease;
}

.filtre-heure:hover, .filtre-heure.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    transform: scale(1.05);
    color: white;
}

.jour-navigation {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.jour-navigation:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    color: white;
}

.recap-card {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    border-radius: 12px;
    padding: 15px;
}

.floating-validation {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

.btn-validation {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 1.1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.btn-validation:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    color: white;
}

.badge-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

.hover-bg-light:hover {
    background-color: #e9ecef !important;
}

.cursor-pointer {
    cursor: pointer;
}

/* Nouveaux styles pour le bouton de validation en bas de page */
#btnValiderFinal {
    min-width: 250px;
    transition: all 0.3s ease;
}

#btnValiderFinal:disabled {
    background: #6c757d !important;
    border-color: #6c757d !important;
    cursor: not-allowed;
    opacity: 0.65;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.6s ease;
}

@media (max-width: 768px) {
    .atelier-card {
        margin-bottom: 10px;
    }
    
    .floating-validation {
        bottom: 20px;
        right: 20px;
    }
    
    .btn-validation {
        padding: 12px 20px;
        font-size: 1rem;
    }
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-present { background-color: #28a745; }
.status-absent { background-color: #dc3545; }
.status-pending { background-color: #ffc107; }

/* NOUVEAUX STYLES POUR L'INTERFACE UNIFI√âE */
.classe-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    margin-bottom: 20px;
    overflow: hidden;
}

.classe-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.classe-header {
    cursor: pointer;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.classe-header:hover {
    background: linear-gradient(135deg, #e7f3ff 0%, #cce7ff 100%);
}

.classe-header.expanded {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-bottom-color: #c3e6cb;
}

.classe-content {
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s ease;
    background-color: #ffffff;
}

.classe-content.expanded {
    max-height: 800px;
    padding: 20px;
}

.apprenant-list {
    max-height: 400px;
    overflow-y: auto;
}

.apprenant-item-integre {
    padding: 10px 15px;
    margin: 0;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #ffffff;
    height: 100%;
}

.apprenant-item-integre:hover {
    background-color: #f8f9fa;
    transform: translateX(3px);
}

.apprenant-item-integre.present {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.apprenant-item-integre.absent {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.chevron-indicator {
    transition: transform 0.3s ease;
}

.chevron-indicator.expanded {
    transform: rotate(180deg);
}

/* Styles pour le formulaire d'ajout d'apprenants temporaires */
.form-control-lg {
    border-radius: 8px;
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
}

.form-control-lg:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
}

#nomTemporaire:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

#prenomTemporaire:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
}

.apercu-affichage {
    border: 2px dashed #007bff;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    transition: all 0.3s ease;
}

.apercu-affichage:hover {
    background: linear-gradient(135deg, #e7f3ff 0%, #cce7ff 100%);
}

.stats-mini {
    font-size: 0.9rem;
}

.btn-action-classe {
    padding: 5px 10px;
    font-size: 0.8rem;
    margin: 2px;
}

/* STYLES POUR APPRENANTS TEMPORAIRES */
.apprenant-temporaire {
    background-color: #fff3cd !important;
    border-color: #ffc107 !important;
    color: #856404 !important;
    position: relative;
    border-width: 2px !important;
}

.apprenant-temporaire::before {
    content: "";
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    background: linear-gradient(45deg, #ff8c00, #ffa500);
    border-radius: 10px;
    z-index: -1;
}

.badge-temporaire {
    background-color: #ff8c00 !important;
    color: white !important;
    animation: pulse-orange 2s infinite;
    font-weight: bold;
}

@keyframes pulse-orange {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
    100% { opacity: 1; transform: scale(1); }
}

.btn-group-sm .btn {
    padding: 0.15rem 0.3rem;
    font-size: 0.75rem;
    line-height: 1.2;
}

.alert-post-it {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
    border-left: 4px solid #ff8c00;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .classe-card {
        margin-bottom: 15px;
    }
    
    .classe-header {
        padding: 12px;
    }
    
    .classe-content.expanded {
        padding: 15px;
    }
}
</style>

<div class="container-fluid">
    <!-- En-t√™te avec navigation des jours -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h3 class="mb-0">
                                <i class="fas fa-clipboard-check"></i> Pointage Pr√©sences
                            </h3>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="recap-card">
                                <h5 class="mb-1" id="dateInfo">Lundi 22 Juillet 2025</h5>
                                <small id="ateliersCount">0 ateliers programm√©s</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn jour-navigation" onclick="changerJour(-1)">
                                    <i class="fas fa-chevron-left"></i> Pr√©c√©dent
                                </button>
                                <button type="button" class="btn jour-navigation" onclick="allerAujourdhui()">
                                    <i class="fas fa-home"></i> Aujourd'hui
                                </button>
                                <button type="button" class="btn jour-navigation" onclick="changerJour(1)">
                                    Suivant <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres par heure -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-clock"></i> Filtrer par cr√©neaux horaires
                    </h6>
                    <button class="btn btn-sm btn-outline-light" onclick="reinitialiserFiltrage()" title="R√©initialiser le filtrage sauvegard√©">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-center" id="filtresHeures">
                        <button class="btn filtre-heure active" data-heure="all" onclick="filtrerParHeure('all')">
                            <i class="fas fa-list"></i> Tous les cr√©neaux
                        </button>
                        <!-- Les boutons d'heure seront g√©n√©r√©s dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-info mb-2"></i>
                    <h4 class="text-info" id="totalApprenants">0</h4>
                    <p class="card-text">Total Apprenants</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="fas fa-check fa-2x text-success mb-2"></i>
                    <h4 class="text-success" id="totalPresents">0</h4>
                    <p class="card-text">Pr√©sents</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="fas fa-hourglass-half fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning" id="totalEnAttente">0</h4>
                    <p class="card-text">En Attente</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche d'apprenants -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-search"></i> Recherche rapide d'apprenant
                    </h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" id="rechercheApprenantGlobale" 
                               placeholder="üîç Tapez le nom, pr√©nom ou num√©ro d'un apprenant..."
                               onkeyup="rechercherApprenantGlobal(this.value)"
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" onclick="effacerRechercheGlobale()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <!-- Dropdown des r√©sultats -->
                    <div id="resultatsRechercheGlobale" class="mt-2" style="display: none;">
                        <div class="list-group" id="listeResultatsGlobale">
                            <!-- R√©sultats g√©n√©r√©s dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone des ateliers unifi√© avec pointage int√©gr√© -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-graduation-cap"></i> Classes du jour - Pointage int√©gr√©
                        <span class="badge bg-primary ms-2" id="ateliersVisibles">0</span>
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row" id="listeAteliers">
                        <div class="col-12 text-center text-muted py-5">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>Aucune classe active pour ce jour</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bouton de validation en bas de page -->
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow-sm border-success">
                <div class="card-body text-center">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-check-double text-success"></i> Validation des pr√©sences
                    </h6>
                    
                    <!-- Statistiques d√©taill√©es -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-users"></i> Pr√©sents / Total apprenants
                            </small>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small"><span id="nbPresents">0</span> pr√©sents</span>
                                <span class="small"><span id="nbTotalApprenants">0</span> apprenants</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" id="progressPresents" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-comment-dots"></i> Observations / Total classes
                            </small>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small"><span id="nbObservations">0</span> observations</span>
                                <span class="small"><span id="nbTotalClasses">0</span> classes</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" id="progressObservations" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alerte pour les apprenants temporaires -->
                    <div class="alert alert-post-it mt-3" id="alertePostIt" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-sticky-note fa-2x me-3"></i>
                            <div>
                                <strong>Apprenants temporaires en attente</strong><br>
                                <span id="messagePostIt">0 apprenant(s) temporaire(s) √† r√©soudre avant validation</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success btn-lg" id="btnValiderFinal" onclick="validerDefinitivementDirect()" disabled>
                        <i class="fas fa-save"></i> Valider et enregistrer
                    </button>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            V√©rifiez vos pointages et observations avant de valider
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de validation (masqu√©, conserv√© pour compatibilit√©) -->
<div class="modal fade d-none" id="modalValidation" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-check-double"></i> Validation des Pr√©sences - <span id="modalDateValidation"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    V√©rifiez les pr√©sences avant de valider. Une fois valid√©es, elles seront enregistr√©es dans la base de donn√©es.
                </div>
                
                <!-- R√©capitulatif des modifications -->
                <div id="recapitulatifModifications">
                    <!-- Le contenu sera g√©n√©r√© dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-warning" onclick="modifierPresences()">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                <button type="button" class="btn btn-success" onclick="validerDefinitivement()">
                    <i class="fas fa-check"></i> Valider et enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'ajout d'apprenant √† une classe -->
<div class="modal fade" id="modalAjoutApprenant" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Ajouter un Apprenant - <span id="modalNomClasse"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Section apprenants actuellement assign√©s -->
                <div class="mb-4">
                    <h6><i class="fas fa-users"></i> Apprenants actuellement assign√©s</h6>
                    <div id="listeApprenantsAssignes" class="border rounded p-3" style="max-height: 150px; overflow-y: auto; background-color: #f8f9fa;">
                        <!-- Liste g√©n√©r√©e dynamiquement avec photo -->
                    </div>
                </div>

                <!-- Barre de recherche -->
                <div class="mb-3">
                    <label for="rechercheApprenant" class="form-label">
                        <i class="fas fa-search"></i> Rechercher un apprenant (nom ou num√©ro)
                    </label>
                    <input type="text" class="form-control" id="rechercheApprenant" 
                           placeholder="Tapez le nom ou le num√©ro..." 
                           onkeyup="rechercherApprenantsDisponibles()">
                </div>

                <!-- Liste des apprenants disponibles -->
                <div class="mb-3">
                    <h6><i class="fas fa-user-check"></i> Apprenants disponibles</h6>
                    <div id="listeApprenantsDisponibles" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <!-- Liste g√©n√©r√©e dynamiquement avec photo -->
                    </div>
<script>
// Ajout vignette photo dans les listes du modal d'ajout d'apprenant
function genererItemApprenantAvecPhoto(apprenant) {
    // R√©cup√©rer le num√©ro (6 premiers caract√®res)
    const numero = apprenant.numero ? apprenant.numero.substring(0,6) : '';
    const nomComplet = apprenant.nom_complet || (apprenant.nom + ' ' + apprenant.prenom);
    let defaultPhoto = '/default_profil.jpg';
    if (apprenant.genre) {
        if (apprenant.genre.toLowerCase() === 'f') defaultPhoto = '/photos_profils_apprenants/default_femme.jpg';
        else if (apprenant.genre.toLowerCase() === 'm') defaultPhoto = '/photos_profils_apprenants/default_homme.jpg';
    }
    const photoJpg = `/photos_profils_apprenants/${numero}.jpg`;
    const photoJpeg = `/photos_profils_apprenants/${numero}.jpeg`;
    // Balise img avec fallback jpg/jpeg/default
    const photoImg = `<img src="${photoJpg}" alt="Photo de ${nomComplet}" class="rounded-circle me-2" style="width:36px;height:36px;object-fit:cover;border:1px solid #ccc;" onerror="if(this.src.indexOf('.jpg')>-1){this.src='${photoJpeg}'}else{this.onerror=null;this.src='${defaultPhoto}'}">`;
    return `<div class='d-flex align-items-center mb-1'>${photoImg}<span>${nomComplet}</span></div>`;
}

// Surcharge l'affichage des listes dans le modal
function afficherApprenantsAssignes() {
    const container = document.getElementById('listeApprenantsAssignes');
    if (!classeEnCoursAjout || !classeEnCoursAjout.apprenants) { container.innerHTML = '<em>Aucun</em>'; return; }
    let html = '';
    classeEnCoursAjout.apprenants.forEach(numero => {
        const apprenant = trouverApprenantParNumero(numero);
        if (apprenant) html += genererItemApprenantAvecPhoto(apprenant);
    });
    container.innerHTML = html || '<em>Aucun</em>';
}

function afficherApprenantsDisponibles(filtre) {
    const container = document.getElementById('listeApprenantsDisponibles');
    if (!apprenantsDisponibles) { container.innerHTML = '<em>Aucun</em>'; return; }
    let html = '';
    apprenantsDisponibles.forEach(apprenant => {
        // Filtrage par nom/num√©ro
        if (filtre && !apprenant.nom_complet.toLowerCase().includes(filtre.toLowerCase()) && !apprenant.numero.includes(filtre)) return;
        html += `<div class='d-flex align-items-center mb-1 cursor-pointer' onclick="ajouterApprenantAClasse('${apprenant.numero}')">${genererItemApprenantAvecPhoto(apprenant)}</div>`;
    });
    container.innerHTML = html || '<em>Aucun</em>';
}
</script>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'ajout d'apprenant temporaire -->
<div class="modal fade" id="modalApprenantTemporaire" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-sticky-note"></i> Apprenant temporaire - <span id="modalClasseTemporaire"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Cet apprenant sera marqu√© comme "en attente d'ajout √† l'inscription" et affich√© avec un badge orange.
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nomTemporaire" class="form-label">
                            <i class="fas fa-user"></i> NOM de famille <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="nomTemporaire" 
                               placeholder="NOM en MAJUSCULES" 
                               style="text-transform: uppercase; font-weight: bold; font-size: 1.1rem;"
                               oninput="mettreAJourApercu()">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="prenomTemporaire" class="form-label">
                            <i class="fas fa-user"></i> Pr√©nom <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="prenomTemporaire" 
                               placeholder="Pr√©nom"
                               style="font-size: 1.1rem;"
                               oninput="mettreAJourApercu()">
                    </div>
                </div>
                
                <!-- Aper√ßu de l'affichage -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-eye"></i> Aper√ßu de l'affichage :
                    </label>
                    <div class="border rounded p-3 bg-light apercu-affichage">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-warning text-dark me-2">
                                <i class="fas fa-sticky-note"></i> TEMP
                            </span>
                            <strong id="apercuNomPrenom" class="text-primary">
                                [NOM Pr√©nom]
                            </strong>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Important :</strong> Cet apprenant devra √™tre inscrit d√©finitivement avant la validation finale des pr√©sences.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-warning" onclick="ajouterApprenantTemporaire()">
                    <i class="fas fa-plus"></i> Ajouter temporaire
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let dateActuelle = new Date();
let ateliersJour = [];
let presences = {}; // Structure: {atelier_id: {apprenant_numero: 'present'|'absent'}}
let modificationsCount = 0;
let sauvegardeTimeout = null; // Pour le debounce des observations

// NOUVELLES VARIABLES POUR APPRENANTS TEMPORAIRES
let apprenantsTemporaires = {}; // Structure: {classe_id: {temp_id: {nom, prenom, statut_presence}}}
let tempIdCounter = 1; // Compteur pour IDs temporaires uniques
let classeEnCoursTemporaire = null; // Variable pour la classe en cours de modification

// NOUVELLES VARIABLES POUR LA SAUVEGARDE DU FILTRAGE
let filtrageSauvegarde = {
    creneauSelectionne: 'all',
    classesDepliees: {},
    dateSelectionnee: null // NOUVEAU: Sauvegarder la date s√©lectionn√©e
};

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    chargerJour();
});

// Fonction utilitaire pour debounce
function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(sauvegardeTimeout);
            func(...args);
        };
        clearTimeout(sauvegardeTimeout);
        sauvegardeTimeout = setTimeout(later, wait);
    };
}

// V√©rifier la synchronisation des observations avec le serveur
function verifierSynchronisationObservations() {
    console.log('üîÑ V√©rification synchronisation observations...');
    
    // R√©cup√©rer les observations locales
    const observationsLocales = {};
    ateliersJour.forEach(atelier => {
        const textareaElement = document.getElementById(`observation_${atelier.id}`);
        if (textareaElement) {
            const observation = textareaElement.value.trim();
            if (observation) {
                observationsLocales[atelier.id] = observation;
            }
        }
    });
    
    console.log('üìù Observations locales:', observationsLocales);
    
    // Afficher un indicateur de synchronisation
    const syncIndicator = document.createElement('div');
    syncIndicator.id = 'sync-indicator';
    syncIndicator.innerHTML = 'üîÑ Synchronisation...';
    syncIndicator.style.cssText = 'position:fixed;top:10px;right:10px;background:#007bff;color:white;padding:5px 10px;border-radius:3px;z-index:1000;';
    document.body.appendChild(syncIndicator);
    
    // Simuler la v√©rification avec localStorage comme backup
    setTimeout(() => {
        const observationsTemp = JSON.parse(localStorage.getItem('pointage_temp') || '{}');
        if (observationsTemp.observations) {
            console.log('‚úÖ Observations trouv√©es dans le stockage local');
            syncIndicator.innerHTML = '‚úÖ Synchronis√©';
            syncIndicator.style.background = '#28a745';
        } else {
            console.log('‚ö†Ô∏è Pas d\'observations dans le stockage local');
            syncIndicator.innerHTML = '‚ö†Ô∏è √Ä synchroniser';
            syncIndicator.style.background = '#ffc107';
        }
        
        // Supprimer l'indicateur apr√®s 3 secondes
        setTimeout(() => {
            if (syncIndicator.parentNode) {
                syncIndicator.parentNode.removeChild(syncIndicator);
            }
        }, 3000);
    }, 1000);
}

// Sauvegarde automatique du pointage temporaire
async function sauvegarderPointageTemporaire() {
    try {
        console.log('üöÄ D√©but sauvegarde temporaire...');
        afficherDebugSynchronisation('üöÄ D√©but sauvegarde...');
        
        // Collecter les observations actuelles - NOUVELLE VERSION AM√âLIOR√âE
        const observations = {};
        let observationsCollectees = 0;
        
        // Parcourir TOUTES les classes (pas seulement celles avec pr√©sences)
        ateliersJour.forEach(atelier => {
            const textareaElement = document.getElementById(`observation_${atelier.id}`);
            if (textareaElement) {
                const observation = textareaElement.value.trim();
                if (observation) {
                    observations[atelier.id] = observation;
                    observationsCollectees++;
                    console.log(`üìù Observation collect√©e pour ${atelier.id}: "${observation}"`);
                    afficherDebugSynchronisation(`üìù Obs: ${atelier.id} -> "${observation.substring(0, 20)}..."`);
                }
            }
        });
        
        console.log(`üìä Total observations collect√©es: ${observationsCollectees}`);
        console.log(`üìä Total pr√©sences: ${Object.keys(presences).length}`);
        console.log(`üìä Total apprenants temporaires: ${Object.keys(apprenantsTemporaires).reduce((total, classeId) => total + Object.keys(apprenantsTemporaires[classeId]).length, 0)}`);
        afficherDebugSynchronisation(`üìä Obs: ${observationsCollectees}, Pr√©s: ${Object.keys(presences).length}, Temp: ${Object.keys(apprenantsTemporaires).length}`);

        const donneesTemporaires = {
            date: dateActuelle.toISOString().split('T')[0],
            presences: presences,
            observations: observations,
            apprenants_temporaires: apprenantsTemporaires // NOUVEAU
        };

        console.log('üì§ Donn√©es √† sauvegarder:', donneesTemporaires);

        // Tentative de sauvegarde sur le serveur
        try {
            const response = await fetch('/planning/api/sauvegarder-pointage-temporaire', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(donneesTemporaires)
            });

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error);
            }
            console.log('‚úÖ Sauvegarde serveur r√©ussie');
            afficherDebugSynchronisation('‚úÖ Serveur OK');
        } catch (error) {
            console.warn('‚ö†Ô∏è √âchec sauvegarde serveur, utilisation localStorage:', error);
            afficherDebugSynchronisation('‚ö†Ô∏è Serveur KO -> localStorage');
            // Fallback: sauvegarder en localStorage si le serveur √©choue
            localStorage.setItem('pointage_temporaire', JSON.stringify(donneesTemporaires));
        }
    } catch (error) {
        console.error('‚ùå Erreur lors de la sauvegarde temporaire:', error);
        // Fallback: sauvegarder en localStorage
        try {
            const donneesTemporaires = {
                date: dateActuelle.toISOString().split('T')[0],
                presences: presences,
                observations: {}
            };
            localStorage.setItem('pointage_temporaire', JSON.stringify(donneesTemporaires));
            console.log('üíæ Sauvegarde fallback localStorage r√©ussie');
        } catch (localError) {
            console.error('‚ùå Erreur localStorage:', localError);
        }
    }
}

// Restaurer le pointage temporaire au chargement
async function restaurerPointageTemporaire() {
    try {
        const dateStr = dateActuelle.toISOString().split('T')[0];
        
        // Tentative de chargement depuis le serveur
        let donneesRestaurees = null;
        try {
            const response = await fetch(`/planning/api/charger-pointage-temporaire/${dateStr}`);
            const result = await response.json();
            
            if (result.success && result.data) {
                donneesRestaurees = result.data;
            }
        } catch (error) {
            console.error('Erreur lors du chargement depuis le serveur:', error);
        }

        // Fallback: v√©rifier localStorage
        if (!donneesRestaurees) {
            const donneesLocales = localStorage.getItem('pointage_temporaire');
            if (donneesLocales) {
                const donneesParsees = JSON.parse(donneesLocales);
                if (donneesParsees.date === dateStr) {
                    donneesRestaurees = donneesParsees;
                }
            }
        }

        // Restaurer les donn√©es si trouv√©es
        if (donneesRestaurees) {
            presences = donneesRestaurees.presences || {};
            console.log(`üîÑ Pr√©sences restaur√©es:`, presences);
            
            // NOUVEAU: Restaurer les apprenants temporaires
            apprenantsTemporaires = donneesRestaurees.apprenants_temporaires || {};
            console.log(`üîÑ Apprenants temporaires restaur√©s:`, apprenantsTemporaires);
            
            // Recalculer tempIdCounter pour √©viter les conflits
            let maxTempId = 0;
            Object.values(apprenantsTemporaires).forEach(temporaires => {
                Object.keys(temporaires).forEach(tempId => {
                    const idNumber = parseInt(tempId.split('_')[1]);
                    if (idNumber > maxTempId) {
                        maxTempId = idNumber;
                    }
                });
            });
            tempIdCounter = maxTempId + 1;
            console.log(`üîÑ TempIdCounter mis √† jour: ${tempIdCounter}`);
            
            // IMPORTANT: Mettre √† jour l'affichage IMM√âDIATEMENT apr√®s restauration des pr√©sences
            afficherAteliers(); // Redessiner avec les bonnes donn√©es
            mettreAJourStatistiques(); // Mettre √† jour les compteurs
            mettreAJourModifications(); // Mettre √† jour les barres et boutons
            
            // Restaurer les observations avec plus de d√©tails
            setTimeout(() => {
                const observationsRestaurees = donneesRestaurees.observations || {};
                console.log(`üîÑ Tentative de restauration des observations:`, observationsRestaurees);
                afficherDebugSynchronisation(`üîÑ Restauration: ${Object.keys(observationsRestaurees).length} obs`);
                
                let observationsReussies = 0;
                Object.entries(observationsRestaurees).forEach(([atelierId, observation]) => {
                    const textareaElement = document.getElementById(`observation_${atelierId}`);
                    if (textareaElement) {
                        textareaElement.value = observation;
                        observationsReussies++;
                        console.log(`‚úÖ Observation restaur√©e pour ${atelierId}: "${observation}"`);
                        afficherDebugSynchronisation(`‚úÖ Restaur√©: ${atelierId}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Textarea non trouv√© pour ${atelierId}`);
                        afficherDebugSynchronisation(`‚ö†Ô∏è Textarea manquant: ${atelierId}`);
                    }
                });
                
                console.log(`üìä ${observationsReussies} observation(s) restaur√©e(s) sur ${Object.keys(observationsRestaurees).length}`);
                afficherDebugSynchronisation(`üìä ${observationsReussies}/${Object.keys(observationsRestaurees).length} restaur√©es`);
                
                // Final: Mettre √† jour une derni√®re fois avec les observations
                mettreAJourModifications();
                
                // IMPORTANT: Configurer les event listeners APR√àS avoir restaur√© les valeurs
                configurerSauvegardeObservations();
                
            }, 1000); // Augmenter le d√©lai pour s'assurer que tous les √©l√©ments sont cr√©√©s
        } else {
            console.log('‚ÑπÔ∏è Aucune donn√©e temporaire trouv√©e pour cette date');
        }
    } catch (error) {
        console.error('Erreur lors de la restauration:', error);
    }
}

// Configurer la sauvegarde automatique des observations
function configurerSauvegardeObservations() {
    const textareas = document.querySelectorAll('textarea[id^="observation_"]');
    console.log(`üìù Configuration sauvegarde observations: ${textareas.length} champs trouv√©s`);
    
    textareas.forEach(textarea => {
        // √âviter de dupliquer les event listeners
        if (!textarea.hasAttribute('data-sauvegarde-configuree')) {
            
            // Sauvegarde IMM√âDIATE comme pour les pr√©sences - √† chaque input
            textarea.addEventListener('input', () => {
                console.log(`üíæ Input d√©tect√© pour ${textarea.id}, sauvegarde imm√©diate...`);
                // Affichage debug visible
                afficherDebugSynchronisation(`üíæ Sauvegarde observation ${textarea.id}`);
                // Exactement comme togglePresence() fait pour les pr√©sences
                sauvegarderPointageTemporaire();
                mettreAJourModifications();
            });
            
            // Sauvegarde de confirmation quand on quitte le champ
            textarea.addEventListener('blur', () => {
                console.log(`üíæ Blur d√©tect√© pour ${textarea.id}, sauvegarde confirmation...`);
                afficherDebugSynchronisation(`‚úÖ Confirmation sauvegarde ${textarea.id}`);
                sauvegarderPointageTemporaire();
            });
            
            // Marquer comme configur√©
            textarea.setAttribute('data-sauvegarde-configuree', 'true');
            console.log(`‚úÖ Event listeners configur√©s pour ${textarea.id}`);
        }
    });
}

// Fonction de debug visible pour tracer la synchronisation
/*
function afficherDebugSynchronisation(message) {
    // Cr√©er ou mettre √† jour l'indicateur de debug
    let debugDiv = document.getElementById('debug-synchronisation');
    if (!debugDiv) {
        debugDiv = document.createElement('div');
        debugDiv.id = 'debug-synchronisation';
        debugDiv.style.cssText = `
            position: fixed;
            top: 60px;
            right: 10px;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        `;
        document.body.appendChild(debugDiv);
    }
    
    // Ajouter le message avec timestamp
    const timestamp = new Date().toLocaleTimeString();
    const messageDiv = document.createElement('div');
    messageDiv.innerHTML = `[${timestamp}] ${message}`;
    debugDiv.appendChild(messageDiv);
    
    // Garder seulement les 10 derniers messages
    while (debugDiv.children.length > 10) {
        debugDiv.removeChild(debugDiv.firstChild);
    }
    
    // Auto-scroll vers le bas
    debugDiv.scrollTop = debugDiv.scrollHeight;
}
*/
// Fonction vide pour d√©sactiver temporairement le debug
function afficherDebugSynchronisation(message) {
    // Debug d√©sactiv√© temporairement
}

// ========== FONCTIONS DE SAUVEGARDE DU FILTRAGE ==========

// Sauvegarder l'√©tat du filtrage dans localStorage
function sauvegarderFiltrage() {
    try {
        const filtrage = {
            creneauSelectionne: filtrageSauvegarde.creneauSelectionne,
            classesDepliees: filtrageSauvegarde.classesDepliees,
            dateSelectionnee: dateActuelle.toISOString(), // NOUVEAU: Sauvegarder la date courante
            timestamp: Date.now()
        };
        localStorage.setItem('pointage_filtrage', JSON.stringify(filtrage));
        console.log('üíæ Filtrage sauvegard√©:', filtrage);
    } catch (error) {
        console.error('‚ùå Erreur lors de la sauvegarde du filtrage:', error);
    }
}

// Restaurer l'√©tat du filtrage depuis localStorage
function restaurerFiltrage() {
    try {
        const filtrageStocke = localStorage.getItem('pointage_filtrage');
        if (filtrageStocke) {
            const filtrage = JSON.parse(filtrageStocke);
            console.log('üîÑ Filtrage restaur√©:', filtrage);
            return filtrage;
        }
    } catch (error) {
        console.error('‚ùå Erreur lors de la restauration du filtrage:', error);
    }
    return null;
}

// Appliquer le filtrage restaur√©
function appliquerFiltrageRestaure(filtrage) {
    if (!filtrage) return;
    
    // Restaurer le cr√©neau s√©lectionn√©
    const creneauExiste = ateliersJour.some(a => a.heure_debut === filtrage.creneauSelectionne) || filtrage.creneauSelectionne === 'all';
    
    if (creneauExiste) {
        // Le cr√©neau existe, l'appliquer
        filtrageSauvegarde.creneauSelectionne = filtrage.creneauSelectionne;
        filtrerParHeure(filtrage.creneauSelectionne);
        console.log(`‚úÖ Cr√©neau "${filtrage.creneauSelectionne}" restaur√©`);
    } else {
        // Le cr√©neau n'existe pas, afficher un message et revenir √† "Tous"
        console.log(`‚ö†Ô∏è Cr√©neau "${filtrage.creneauSelectionne}" non disponible aujourd'hui`);
        afficherMessageCreneauIndisponible(filtrage.creneauSelectionne);
        filtrageSauvegarde.creneauSelectionne = 'all';
        filtrerParHeure('all');
    }
    
    // Restaurer l'√©tat des classes d√©pli√©es
    filtrageSauvegarde.classesDepliees = filtrage.classesDepliees || {};
}

// Afficher un message quand le cr√©neau sauvegard√© n'est pas disponible
function afficherMessageCreneauIndisponible(creneauManquant) {
    const message = document.createElement('div');
    message.className = 'alert alert-warning alert-dismissible fade show';
    message.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1050; max-width: 400px;';
    message.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Filtrage restaur√© :</strong> Le cr√©neau "${creneauManquant}" n'est pas disponible aujourd'hui.
        <br>Affichage de toutes les classes.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(message);
    
    // Supprimer automatiquement apr√®s 5 secondes
    setTimeout(() => {
        if (message.parentNode) {
            message.remove();
        }
    }, 5000);
}

// Sauvegarder l'√©tat d'une classe (d√©pli√©e/repli√©e)
function sauvegarderEtatClasse(atelierId, estDepliee) {
    filtrageSauvegarde.classesDepliees[atelierId] = estDepliee;
    sauvegarderFiltrage();
}

// R√©initialiser compl√®tement le filtrage sauvegard√©
function reinitialiserFiltrage() {
    // Confirmer avant de r√©initialiser
    if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le filtrage sauvegard√© ?')) {
        try {
            // Supprimer de localStorage
            localStorage.removeItem('pointage_filtrage');
            
            // R√©initialiser les variables locales
            filtrageSauvegarde = {
                creneauSelectionne: 'all',
                classesDepliees: {},
                dateSelectionnee: null // NOUVEAU: R√©initialiser aussi la date
            };
            
            // Appliquer le filtrage par d√©faut
            filtrerParHeure('all');
            
            // Afficher un message de confirmation
            const message = document.createElement('div');
            message.className = 'alert alert-success alert-dismissible fade show';
            message.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1050; max-width: 350px;';
            message.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Filtrage r√©initialis√© !</strong> Toutes les pr√©f√©rences ont √©t√© supprim√©es.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(message);
            
            // Supprimer automatiquement apr√®s 3 secondes
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 3000);
            
            console.log('‚úÖ Filtrage r√©initialis√© avec succ√®s');
        } catch (error) {
            console.error('‚ùå Erreur lors de la r√©initialisation:', error);
        }
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // NOUVEAU: Restaurer la date sauvegard√©e avant de charger
    const filtrageRestaure = restaurerFiltrage();
    if (filtrageRestaure && filtrageRestaure.dateSelectionnee) {
        dateActuelle = new Date(filtrageRestaure.dateSelectionnee);
        console.log('üìÖ Date restaur√©e:', dateActuelle.toLocaleDateString('fr-FR'));
    }
    
    chargerJour();
});

// Nettoyer le localStorage en fin de session (optionnel)
window.addEventListener('beforeunload', function() {
    // Note: Garder les donn√©es pour la session, elles seront automatiquement supprim√©es √† la fermeture du navigateur
    console.log('üìù Session se termine, donn√©es de filtrage conserv√©es jusqu\'√† fermeture du navigateur');
});

function changerJour(direction) {
    dateActuelle.setDate(dateActuelle.getDate() + direction);
    filtrageSauvegarde.dateSelectionnee = dateActuelle.toISOString(); // NOUVEAU: Sauvegarder la nouvelle date
    sauvegarderFiltrage(); // NOUVEAU: Sauvegarder imm√©diatement
    chargerJour();
}

function allerAujourdhui() {
    dateActuelle = new Date();
    filtrageSauvegarde.dateSelectionnee = dateActuelle.toISOString(); // NOUVEAU: Sauvegarder la date d'aujourd'hui
    sauvegarderFiltrage(); // NOUVEAU: Sauvegarder imm√©diatement
    chargerJour();
}

async function chargerJour() {
    try {
        // NOUVEAU: Sauvegarder la date courante √† chaque chargement
        filtrageSauvegarde.dateSelectionnee = dateActuelle.toISOString();
        
        // Mettre √† jour l'affichage de la date
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        document.getElementById('dateInfo').textContent = 
            dateActuelle.toLocaleDateString('fr-FR', options);
        
        // Charger uniquement les classes actives du jour
        const nomJour = dateActuelle.toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase();
        const classesActives = classes.filter(classe => 
            classe.active && 
            classe.jours && 
            classe.jours.map(j => j.toLowerCase()).includes(nomJour)
        );
        
        // Convertir les classes en format atelier pour l'affichage
        ateliersJour = classesActives.map(classe => ({
            id: `classe_${classe.id}`, // Pr√©fixe pour distinguer des ateliers du planning
            activite: classe.activite,
            encadrant: classe.encadrant,
            heure_debut: classe.heure_debut,
            heure_fin: classe.heure_fin,
            apprenants: classe.apprenants || [],
            jour: nomJour,
            source: 'classe', // Marquer la source
            nom_classe: classe.nom
        }));
        
        afficherAteliers();
        genererFiltresHeures();
        mettreAJourStatistiques();
        
        // NOUVEAU: Restaurer le pointage temporaire apr√®s avoir charg√© les ateliers
        await restaurerPointageTemporaire();
        
        // NOUVEAU: Restaurer le filtrage sauvegard√©
        setTimeout(() => {
            const filtrageRestaure = restaurerFiltrage();
            appliquerFiltrageRestaure(filtrageRestaure);
        }, 500);
        
        // NOUVEAU: D√©plier automatiquement toutes les classes pour faciliter l'utilisation (seulement si pas de filtrage sauvegard√©)
        setTimeout(() => {
            const filtrageRestaure = restaurerFiltrage();
            if (!filtrageRestaure || Object.keys(filtrageRestaure.classesDepliees || {}).length === 0) {
                console.log('üîß Auto-d√©pliement des classes (pas de sauvegarde)...');
                ateliersJour.forEach(atelier => {
                    toggleClasseContent(atelier.id);
                });
                console.log(`üîß ${ateliersJour.length} classe(s) d√©pli√©e(s) automatiquement`);
            } else {
                console.log('üîß Restauration des √©tats sauvegard√©s des classes...');
                Object.entries(filtrageRestaure.classesDepliees).forEach(([atelierId, estDepliee]) => {
                    if (estDepliee) {
                        const content = document.getElementById(`content_${atelierId}`);
                        const chevron = document.getElementById(`chevron_${atelierId}`);
                        const header = content?.previousElementSibling;
                        
                        if (content && !content.classList.contains('expanded')) {
                            content.classList.add('expanded');
                            if (chevron) chevron.classList.add('expanded');
                            if (header) header.classList.add('expanded');
                        }
                    }
                });
            }
        }, 1000);
        
        // D√©marrer la v√©rification p√©riodique de synchronisation
        console.log('üîÑ D√©marrage v√©rification synchronisation p√©riodique...');
        setTimeout(() => {
            verifierSynchronisationObservations();
            
            // V√©rification toutes les 30 secondes
            setInterval(() => {
                verifierSynchronisationObservations();
            }, 30000);
        }, 2000); // Attendre 2 secondes apr√®s le chargement initial
        
    } catch (error) {
        console.error('Erreur:', error);
        ateliersJour = [];
        afficherAteliers();
    }
}

function afficherAteliers() {
    const container = document.getElementById('listeAteliers');
    const countElement = document.getElementById('ateliersCount');
    const visiblesElement = document.getElementById('ateliersVisibles');
    
    console.log('üé® Affichage ateliers - Donn√©es pr√©sences actuelles:', presences);
    console.log('üé® Ateliers du jour:', ateliersJour);
    console.log('üé® Apprenants temporaires:', apprenantsTemporaires);
    afficherDebugSynchronisation('üé® Affichage mis √† jour');
    
    countElement.textContent = `${ateliersJour.length} classe${ateliersJour.length > 1 ? 's' : ''} active${ateliersJour.length > 1 ? 's' : ''}`;
    
    if (ateliersJour.length === 0) {
        console.log('‚ö†Ô∏è Aucune classe active trouv√©e');
        container.innerHTML = `
            <div class="col-12 text-center text-muted py-5">
                <i class="fas fa-graduation-cap fa-3x mb-3"></i>
                <p>Aucune classe active pour ce jour</p>
                <small>V√©rifiez les classes dans la gestion des classes</small>
            </div>
        `;
        visiblesElement.textContent = '0';
        return;
    }
    
    let html = '';
    ateliersJour.forEach(atelier => {
        const nbApprenants = atelier.apprenants ? atelier.apprenants.length : 0;
        const presentsCount = compterPresents(atelier.id);
        const enAttenteCount = nbApprenants - presentsCount;
        
        console.log(`üìä Classe ${atelier.id}: ${presentsCount}/${nbApprenants} pr√©sents`);
        
        // Header de la classe (cliquable pour d√©plier)
        html += `
            <div class="col-12" data-atelier-id="${atelier.id}" data-heure="${atelier.heure_debut}">
                <div class="classe-card">
                    <!-- Header cliquable -->
                    <div class="classe-header" onclick="toggleClasseContent('${atelier.id}')">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h6 class="mb-1">
                                    <i class="fas fa-graduation-cap text-primary"></i> 
                                    ${atelier.activite}
                                    <span class="badge bg-info ms-2">${atelier.nom_classe}</span>
                                </h6>
                                <div class="stats-mini text-muted">
                                    <i class="fas fa-clock"></i> ${atelier.heure_debut}-${atelier.heure_fin} 
                                    <span class="ms-2"><i class="fas fa-user-tie"></i> ${atelier.encadrant}</span>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="d-flex justify-content-end align-items-center">
                                                                        <div class="me-3" style=" border-radius: 8px; margin-right: 8px; padding: 2px 8px;">
                                        <span class="badge" style="background-color: #ff8c00; color: white;">${compterPresentsTemporaires(atelier.id)}</span>
                                    </div>
                                    <div class="me-3">
                                        <span class="badge bg-success">${presentsCount + compterPresentsTemporaires(atelier.id)}</span>
                                        <span class="text-muted">/</span>
                                        <span class="badge bg-secondary">${nbApprenants + (apprenantsTemporaires[atelier.id] ? Object.keys(apprenantsTemporaires[atelier.id]).length : 0)}</span>
                                    </div>

                                    <i class="fas fa-chevron-down chevron-indicator" id="chevron_${atelier.id}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenu d√©pliable -->
                    <div class="classe-content" id="content_${atelier.id}">
                        <!-- Actions rapides -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <button class="btn btn-outline-primary btn-action-classe me-2" onclick="event.stopPropagation(); ouvrirModalAjoutApprenant('${atelier.id}', '${atelier.nom_classe}')">
                                    <i class="fas fa-user-plus"></i> Ajouter apprenant
                                </button>
                                <button class="btn btn-outline-warning btn-action-classe" onclick="event.stopPropagation(); ouvrirModalApprenantTemporaire('${atelier.id}', '${atelier.nom_classe}')">
                                    <i class="fas fa-sticky-note"></i> +Ajouter apprenant temporaire
                                </button>
                            </div>
                        </div>
                        
                        <!-- Liste des apprenants avec pointage int√©gr√© -->
                        <div class="apprenant-list" id="apprenants_${atelier.id}">
                            ${genererListeApprenants(atelier)}
                        </div>
                        
                        <!-- Champ d'observation -->
                        <div class="row mt-3">
                            <div class="col-12">

                                <textarea class="form-control form-control-sm" id="observation_${atelier.id}" 
                                          placeholder="Ajouter une observation pour cette classe..." 
                                          rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    visiblesElement.textContent = ateliersJour.length.toString();
    
    // Configurer la sauvegarde automatique des observations apr√®s affichage
    setTimeout(() => {
        configurerSauvegardeObservations();
    }, 100);
}

// Nouvelle fonction pour g√©n√©rer la liste des apprenants
function genererListeApprenants(atelier) {
    const apprenants = atelier.apprenants || [];
    const temporaires = apprenantsTemporaires[atelier.id] || {};
    
    if (apprenants.length === 0 && Object.keys(temporaires).length === 0) {
        return `
            <div class="text-center text-muted py-3">
                <i class="fas fa-user-slash fa-2x mb-2"></i>
                <p>Aucun apprenant assign√© √† cette classe</p>
                <small>Utilisez les boutons ci-dessus pour ajouter des apprenants</small>
            </div>
        `;
    }
    
    let html = '<div class="row">';
    
    // Apprenants permanents existants
    apprenants.forEach(numeroApprenant => {
        const apprenant = trouverApprenantParNumero(numeroApprenant);
        const nomComplet = apprenant ? apprenant.nom_complet : `Apprenant ${numeroApprenant}`;
        const statut = obtenirStatutApprenant(atelier.id, numeroApprenant);

        let classeStatut = '';
        let iconeStatut = 'fas fa-hourglass-half text-warning';
        let couleurStatut = 'status-pending';

        if (statut === 'present') {
            classeStatut = 'present';
            iconeStatut = 'fas fa-check text-success';
            couleurStatut = 'status-present';
        } else if (statut === 'absent') {
            classeStatut = 'absent';
            iconeStatut = 'fas fa-times text-danger';
            couleurStatut = 'status-absent';
        }

    // Construction du chemin de la photo : uniquement num√©ro apprenant (6 premiers caract√®res)
    let numeroPhoto = numeroApprenant.substring(0, 6);
    let photoJpg = `/photos_profils_apprenants/${numeroPhoto}.jpg`;
    let photoJpeg = `/photos_profils_apprenants/${numeroPhoto}.jpeg`;
    // Debug : afficher le chemin g√©n√©r√© pour chaque apprenant
    console.log(`[PHOTO DEBUG] Apprenant:`, numeroApprenant, '| JPG:', photoJpg, '| JPEG:', photoJpeg);
        // Image par d√©faut selon le genre si connu, sinon default.jpg
        let defaultPhoto = '/default_profil.jpg';
        if (apprenant && apprenant.genre) {
            if (apprenant.genre.toLowerCase() === 'f') {
                defaultPhoto = '/photos_profils_apprenants/default_femme.jpg';
            } else if (apprenant.genre.toLowerCase() === 'm') {
                defaultPhoto = '/photos_profils_apprenants/default_homme.jpg';
            }
        }

        // Balise img avec gestion du fallback jpg/jpeg/default
        // On utilise onerror pour basculer de jpg -> jpeg -> default
        let photoImg = `<img src="${photoJpg}"
            alt="Photo de ${nomComplet}"
            class="rounded-circle me-2" style="width:44px;height:44px;object-fit:cover;border:1px solid #ccc;"
            onerror="if(this.src.indexOf('.jpg')>-1){this.src='${photoJpeg}'}else{this.onerror=null;this.src='${defaultPhoto}'}"
        >`;

        html += `
            <div class="col-lg-4 col-md-6 col-12 mb-2">
                <div class="apprenant-item-integre ${classeStatut}" data-atelier-id="${atelier.id}" data-apprenant-numero="${numeroApprenant}" onclick="basculerPresence('${atelier.id}', '${numeroApprenant}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            ${photoImg}
                            <div>
                                <span class="status-indicator ${couleurStatut}"></span>
                                <strong>${nomComplet}</strong><br>
                                <small class="text-muted">N¬∞ ${numeroApprenant}</small>
                            </div>
                        </div>
                        <div>
                            <i class="${iconeStatut} fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Les apprenants temporaires n'ont JAMAIS de photo !
    // Bloc r√©serv√© uniquement √† l'affichage du nom/pr√©nom et actions, sans balise <img> ni logique de photo
    Object.entries(temporaires).forEach(([tempId, apprenant]) => {
        const statut = apprenant.statut_presence || 'pending';
        let classeStatut = '';
        let iconeStatut = 'fas fa-hourglass-half text-warning';
        let couleurStatut = 'status-pending';
        if (statut === 'present') {
            classeStatut = 'present';
            iconeStatut = 'fas fa-check text-success';
            couleurStatut = 'status-present';
        }
        html += `
            <div class="col-lg-4 col-md-6 col-12 mb-2">
                <div class="apprenant-item-integre apprenant-temporaire ${classeStatut}" data-atelier-id="${atelier.id}" data-temp-id="${tempId}" onclick="basculerPresenceTemporaire('${atelier.id}', '${tempId}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge badge-temporaire">
                                <i class="fas fa-sticky-note"></i> TEMP
                            </span>
                            <strong class="text-primary" style="font-size: 1.1rem;">${apprenant.nom} ${apprenant.prenom}</strong><br>
                            <small class="text-warning">En attente d'inscription</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="${iconeStatut} fa-lg me-2"></i>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); redirigerVersInscription('${tempId}')" title="Inscrire d√©finitivement">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); supprimerApprenantTemporaire('${atelier.id}', '${tempId}')" title="Supprimer">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    return html;
}

// Nouvelle fonction pour d√©plier/replier le contenu
function toggleClasseContent(atelierId) {
    const content = document.getElementById(`content_${atelierId}`);
    const chevron = document.getElementById(`chevron_${atelierId}`);
    const header = content.previousElementSibling;
    
    if (content.classList.contains('expanded')) {
        // Replier
        content.classList.remove('expanded');
        chevron.classList.remove('expanded');
        header.classList.remove('expanded');
        sauvegarderEtatClasse(atelierId, false);
    } else {
        // D√©plier
        content.classList.add('expanded');
        chevron.classList.add('expanded');
        header.classList.add('expanded');
        sauvegarderEtatClasse(atelierId, true);
    }
}

function genererFiltresHeures() {
    const container = document.getElementById('filtresHeures');
    
    // Garder le bouton "Tous"
    const btnTous = container.querySelector('[data-heure="all"]');
    container.innerHTML = '';
    container.appendChild(btnTous);
    
    // Extraire les heures uniques
    const heures = [...new Set(ateliersJour.map(a => a.heure_debut))].sort();
    
    heures.forEach(heure => {
        const btn = document.createElement('button');
        btn.className = 'btn filtre-heure';
        btn.setAttribute('data-heure', heure);
        btn.onclick = () => filtrerParHeure(heure);
        btn.innerHTML = `<i class="fas fa-clock"></i> ${heure}`;
        container.appendChild(btn);
    });
}

function filtrerParHeure(heure) {
    // Sauvegarder le cr√©neau s√©lectionn√©
    filtrageSauvegarde.creneauSelectionne = heure;
    sauvegarderFiltrage();
    
    // Mettre √† jour les boutons actifs
    document.querySelectorAll('.filtre-heure').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-heure="${heure}"]`).classList.add('active');
    
    // Filtrer les classes (s√©lecteur corrig√© pour cibler uniquement les cartes principales)
    const classes = document.querySelectorAll('.col-12[data-atelier-id]');
    let visibles = 0;
    const classesVisibles = [];
    
    classes.forEach(card => {
        if (heure === 'all' || card.getAttribute('data-heure') === heure) {
            card.style.display = 'block';
            visibles++;
            classesVisibles.push(card.getAttribute('data-atelier-id'));
        } else {
            card.style.display = 'none';
        }
    });
    
    // NOUVEAU: Auto-d√©plier les classes filtr√©es avec d√©lai adapt√© √† l'animation CSS
    setTimeout(() => {
        classesVisibles.forEach(atelierId => {
            const content = document.getElementById(`content_${atelierId}`);
            const chevron = document.getElementById(`chevron_${atelierId}`);
            const header = content?.previousElementSibling;
            
            if (content) {
                // Forcer l'expansion m√™me si d√©j√† ouverte pour s'assurer de la visibilit√©
                content.classList.add('expanded');
                if (chevron) chevron.classList.add('expanded');
                if (header) header.classList.add('expanded');
                
                // Sauvegarder l'√©tat d√©pli√©e
                sauvegarderEtatClasse(atelierId, true);
                
                console.log(`üîß D√©pliement forc√© pour classe ${atelierId}`);
            }
        });
        console.log(`üîß Auto-d√©pliement apr√®s filtrage: ${classesVisibles.length} classe(s)`);
    }, 500); // D√©lai augment√© pour laisser le temps aux animations CSS
    
    // Mettre √† jour le compteur de classes visibles
    document.getElementById('ateliersVisibles').textContent = visibles.toString();
}

// Fonction pour basculer les pr√©sences (version optimis√©e)
function basculerPresence(atelierId, numeroApprenant) {
    console.log(`üéØ Clic d√©tect√© sur apprenant ${numeroApprenant} de la classe ${atelierId}`);
    afficherDebugSynchronisation(`üéØ Clic: ${numeroApprenant} -> ${atelierId}`);
    
    if (!presences[atelierId]) {
        presences[atelierId] = {};
    }
    
    const statutActuel = presences[atelierId][numeroApprenant];
    console.log(`üìä Statut actuel: ${statutActuel || 'pending'}`);
    
    // Simple toggle : pr√©sent ou non-pr√©sent (supprim√©)
    let nouveauStatut;
    if (statutActuel === 'present') {
        delete presences[atelierId][numeroApprenant];
        nouveauStatut = 'pending';
        console.log(`‚ùå Suppression pr√©sence pour ${numeroApprenant}`);
        afficherDebugSynchronisation(`‚ùå ${numeroApprenant} -> absent`);
    } else {
        presences[atelierId][numeroApprenant] = 'present';
        nouveauStatut = 'present';
        console.log(`‚úÖ Ajout pr√©sence pour ${numeroApprenant}`);
        afficherDebugSynchronisation(`‚úÖ ${numeroApprenant} -> pr√©sent`);
    }
    
    // NOUVELLE APPROCHE: Mettre √† jour seulement l'√©l√©ment cliqu√© sans r√©g√©n√©rer tout le HTML
    mettreAJourElementApprenant(atelierId, numeroApprenant, nouveauStatut);
    
    mettreAJourModifications();
    mettreAJourStatistiques();
    
    // Sauvegarde automatique apr√®s chaque clic
    sauvegarderPointageTemporaire();
}

// NOUVELLE FONCTION: Mettre √† jour un √©l√©ment apprenant sp√©cifique
function mettreAJourElementApprenant(atelierId, numeroApprenant, statut) {
    const element = document.querySelector(`[data-atelier-id="${atelierId}"][data-apprenant-numero="${numeroApprenant}"]`);
    if (!element) {
        console.warn(`‚ö†Ô∏è √âl√©ment apprenant non trouv√©: ${numeroApprenant} dans ${atelierId}`);
        return;
    }
    
    // Supprimer les anciennes classes de statut
    element.classList.remove('present', 'absent');
    
    // Trouver les √©l√©ments √† mettre √† jour
    const statusIndicator = element.querySelector('.status-indicator');
    const icone = element.querySelector('i[class*="fa-"]');
    
    // Appliquer le nouveau statut
    let classeStatut = '';
    let iconeClass = 'fas fa-hourglass-half text-warning';
    let couleurStatut = 'status-pending';
    
    if (statut === 'present') {
        classeStatut = 'present';
        iconeClass = 'fas fa-check text-success';
        couleurStatut = 'status-present';
    } else if (statut === 'absent') {
        classeStatut = 'absent';
        iconeClass = 'fas fa-times text-danger';
        couleurStatut = 'status-absent';
    }
    
    // Mettre √† jour l'√©l√©ment
    if (classeStatut) {
        element.classList.add(classeStatut);
    }
    
    if (statusIndicator) {
        statusIndicator.className = `status-indicator ${couleurStatut}`;
    }
    
    if (icone) {
        icone.className = `${iconeClass} fa-lg`;
    }
    
    // Mettre √† jour les compteurs dans le header
    const presentsCount = compterPresents(atelierId);
    const headerCard = document.querySelector(`[data-atelier-id="${atelierId}"] .classe-header`);
    if (headerCard) {
        const badgeSuccess = headerCard.querySelector('.badge.bg-success');
        if (badgeSuccess) {
            // Inclure les temporaires dans le comptage
            const presentsTemporaires = compterPresentsTemporaires(atelierId);
            badgeSuccess.textContent = presentsCount + presentsTemporaires;
        }
    }
    
    console.log(`üîÑ √âl√©ment mis √† jour pour ${numeroApprenant}: ${statut}`);
}

// Fonctions utilitaires pour les statuts

function obtenirStatutApprenant(atelierId, numeroApprenant) {
    return presences[atelierId] && presences[atelierId][numeroApprenant] ? presences[atelierId][numeroApprenant] : 'pending';
}

function compterPresents(atelierId) {
    if (!presences[atelierId]) return 0;
    return Object.values(presences[atelierId]).filter(statut => statut === 'present').length;
}

function compterAbsents(atelierId) {
    if (!presences[atelierId]) return 0;
    return Object.values(presences[atelierId]).filter(statut => statut === 'absent').length;
}

function mettreAJourStatistiques() {
    let totalApprenants = 0;
    let totalPresents = 0;
    
    ateliersJour.forEach(atelier => {
        // Compter les apprenants permanents
        const nbApprenants = atelier.apprenants ? atelier.apprenants.length : 0;
        totalApprenants += nbApprenants;
        totalPresents += compterPresents(atelier.id);
        
        // Compter les apprenants temporaires
        const nbTemporaires = apprenantsTemporaires[atelier.id] ? Object.keys(apprenantsTemporaires[atelier.id]).length : 0;
        totalApprenants += nbTemporaires;
        totalPresents += compterPresentsTemporaires(atelier.id);
    });
    
    const totalEnAttente = totalApprenants - totalPresents;
    
    document.getElementById('totalApprenants').textContent = totalApprenants;
    document.getElementById('totalPresents').textContent = totalPresents;
    document.getElementById('totalEnAttente').textContent = totalEnAttente;
}

function mettreAJourModifications() {
    // Compter les pr√©sents (permanents et temporaires)
    let totalPresents = 0;
    let totalApprenants = 0;
    
    ateliersJour.forEach(atelier => {
        // Apprenants permanents
        const nbApprenants = atelier.apprenants ? atelier.apprenants.length : 0;
        totalApprenants += nbApprenants;
        totalPresents += compterPresents(atelier.id);
        
        // Apprenants temporaires
        const nbTemporaires = apprenantsTemporaires[atelier.id] ? Object.keys(apprenantsTemporaires[atelier.id]).length : 0;
        totalApprenants += nbTemporaires;
        totalPresents += compterPresentsTemporaires(atelier.id);
    });
    
    // Compter les observations
    let totalObservations = 0;
    let totalClasses = ateliersJour.length;
    
    ateliersJour.forEach(atelier => {
        const textareaElement = document.getElementById(`observation_${atelier.id}`);
        if (textareaElement && textareaElement.value.trim() !== '') {
            totalObservations++;
        }
    });
    
    // NOUVEAU: V√©rifier les post-it restants
    const postItRestants = verifierPostItRestants();
    
    // Mettre √† jour les affichages
    const btnValiderFinal = document.getElementById('btnValiderFinal');
    const nbPresents = document.getElementById('nbPresents');
    const nbTotalApprenants = document.getElementById('nbTotalApprenants');
    const nbObservations = document.getElementById('nbObservations');
    const nbTotalClasses = document.getElementById('nbTotalClasses');
    const progressPresents = document.getElementById('progressPresents');
    const progressObservations = document.getElementById('progressObservations');
    const alertePostIt = document.getElementById('alertePostIt');
    const messagePostIt = document.getElementById('messagePostIt');
    
    if (btnValiderFinal && nbPresents && nbTotalApprenants && nbObservations && nbTotalClasses) {
        // Mettre √† jour les compteurs
        nbPresents.textContent = totalPresents;
        nbTotalApprenants.textContent = totalApprenants;
        nbObservations.textContent = totalObservations;
        nbTotalClasses.textContent = totalClasses;
        
        // Calculer les pourcentages
        const pourcentagePresents = totalApprenants > 0 ? (totalPresents / totalApprenants) * 100 : 0;
        const pourcentageObservations = totalClasses > 0 ? (totalObservations / totalClasses) * 100 : 0;
        
        // Mettre √† jour les barres de progression
        progressPresents.style.width = pourcentagePresents + '%';
        progressObservations.style.width = pourcentageObservations + '%';
        
        // NOUVEAU: Gestion de l'alerte post-it
        if (postItRestants > 0) {
            alertePostIt.style.display = 'block';
            messagePostIt.textContent = `${postItRestants} apprenant(s) temporaire(s) √† r√©soudre avant validation`;
        } else {
            alertePostIt.style.display = 'none';
        }
        
        // √âtat du bouton - MODIFI√â pour inclure les post-it
        if (totalPresents > 0 && postItRestants === 0) {
            btnValiderFinal.disabled = false;
            btnValiderFinal.classList.remove('btn-secondary');
            btnValiderFinal.classList.add('btn-success');
        } else {
            btnValiderFinal.disabled = true;
            btnValiderFinal.classList.remove('btn-success');
            btnValiderFinal.classList.add('btn-secondary');
        }
    }
    
    // Mettre √† jour le compteur global pour compatibilit√©
    modificationsCount = totalPresents;
}

function ouvrirModalValidation() {
    // Mettre √† jour la date dans le modal
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    document.getElementById('modalDateValidation').textContent = 
        dateActuelle.toLocaleDateString('fr-FR', options);
    
    // G√©n√©rer le r√©capitulatif
    genererRecapitulatif();
    
    // Ouvrir le modal
    const modal = new bootstrap.Modal(document.getElementById('modalValidation'));
    modal.show();
}

function genererRecapitulatif() {
    const container = document.getElementById('recapitulatifModifications');
    let html = '';
    
    ateliersJour.forEach(atelier => {
        if (presences[atelier.id] && Object.keys(presences[atelier.id]).length > 0) {
            // Compter les pr√©sents pour cette classe
            const presentsCount = Object.values(presences[atelier.id]).filter(statut => statut === 'present').length;
            
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-tasks"></i> ${atelier.activite} - ${atelier.nom}
                            <span class="text-muted">(${atelier.heure_debut} - ${atelier.heure_fin})</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
            `;
            
            Object.entries(presences[atelier.id]).forEach(([numeroApprenant, statut]) => {
                const apprenant = trouverApprenantParNumero(numeroApprenant);
                const nomComplet = apprenant ? apprenant.nom_complet : `Apprenant ${numeroApprenant}`;
                const couleur = statut === 'present' ? 'success' : 'danger';
                const icone = statut === 'present' ? 'check' : 'times';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-${couleur}">
                            <i class="fas fa-${icone}"></i> ${nomComplet}
                        </span>
                    </div>
                `;
            });
            
            // Ajouter le champ observation si il y a des pr√©sents
            if (presentsCount > 0) {
                html += `
                        </div>
                        <div class="mt-3">
                            <label for="observation_${atelier.id}" class="form-label">
                                <i class="fas fa-comment"></i> D√©tail/Observation (optionnel):
                            </label>
                            <textarea class="form-control" id="observation_${atelier.id}" 
                                      placeholder="Ajouter une observation pour cette classe..." 
                                      rows="2"></textarea>
                        </div>
                    </div>
                </div>
                `;
            } else {
                html += `
                        </div>
                    </div>
                </div>
                `;
            }
        }
    });
    
    if (html === '') {
        html = '<div class="alert alert-warning">Aucune modification √† valider.</div>';
    }
    
    container.innerHTML = html;
    
    // NOUVEAU: Configurer la sauvegarde automatique des observations apr√®s g√©n√©ration du HTML
    setTimeout(() => {
        configurerSauvegardeObservations();
    }, 100); // Petit d√©lai pour s'assurer que les √©l√©ments sont dans le DOM
}

function modifierPresences() {
    // Fermer le modal
    bootstrap.Modal.getInstance(document.getElementById('modalValidation')).hide();
}

async function validerDefinitivement() {
    try {
        // Collecter les observations pour chaque classe
        const observations = {};
        ateliersJour.forEach(atelier => {
            if (presences[atelier.id]) {
                const textareaElement = document.getElementById(`observation_${atelier.id}`);
                if (textareaElement) {
                    const observation = textareaElement.value.trim();
                    if (observation) {
                        observations[atelier.id] = observation;
                    }
                }
            }
        });
        
        // Pr√©parer les donn√©es √† envoyer
        const donneesValidation = {
            date: dateActuelle.toISOString().split('T')[0],
            presences: presences,
            observations: observations
        };
        
        // Envoyer au serveur
        const response = await fetch('/planning/api/valider-presences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(donneesValidation)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Succ√®s avec message d√©taill√©
            let message = result.message || `${result.nombre_presences} pr√©sences valid√©es avec succ√®s !`;
            
            if (result.apprenants_ignores && result.apprenants_ignores.length > 0) {
                message += `\n\nApprenants ignor√©s (d√©j√† pr√©sents): ${result.apprenants_ignores.join(', ')}`;
            }
            
            alert(message);
            
            // R√©initialiser
            presences = {};
            modificationsCount = 0;
            document.getElementById('btnValider').classList.add('d-none');
            
            // Fermer le modal
            bootstrap.Modal.getInstance(document.getElementById('modalValidation')).hide();
            
            // Rafra√Æchir l'affichage
            afficherAteliers();
            mettreAJourStatistiques();
            
        } else {
            // Gestion des erreurs
            if (result.redirect_to_inscription) {
                // Apprenant non trouv√© - redirection vers inscription
                const confirmer = confirm(
                    result.error + '\n\n' +
                    'Voulez-vous aller √† la page d\'inscription maintenant ?'
                );
                
                if (confirmer) {
                    window.location.href = '/inscriptions';
                }
            } else {
                // Autre erreur
                alert('Erreur lors de la validation : ' + result.error);
            }
        }
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la validation des pr√©sences');
    }
}

// Nouvelle fonction de validation directe (sans modal)
async function validerDefinitivementDirect() {
    // NOUVEAU: V√©rifier les post-it avant validation
    const postItRestants = verifierPostItRestants();
    if (postItRestants > 0) {
        alert(`Impossible de valider : ${postItRestants} apprenant(s) temporaire(s) en attente.\n\n` +
              'Veuillez soit les inscrire d√©finitivement, soit les supprimer avant de valider.');
        return;
    }
    
    // Compter les pr√©sences (permanents + temporaires)
    const nbPresencesPermanents = Object.values(presences).reduce((total, atelierPresences) => 
        total + Object.values(atelierPresences).filter(statut => statut === 'present').length, 0);
    
    const nbPresencesTemporaires = Object.values(apprenantsTemporaires).reduce((total, temporaires) => 
        total + Object.values(temporaires).filter(app => app.statut_presence === 'present').length, 0);
    
    const nbPresencesTotales = nbPresencesPermanents + nbPresencesTemporaires;
    
    if (nbPresencesTotales === 0) {
        alert('Aucune pr√©sence √† valider.');
        return;
    }
    
    const confirmer = confirm(
        `Vous allez valider ${nbPresencesTotales} pr√©sence(s) pour le ${dateActuelle.toLocaleDateString('fr-FR')} ` +
        `(${nbPresencesPermanents} permanents${nbPresencesTemporaires > 0 ? ` + ${nbPresencesTemporaires} temporaires` : ''}).\n\n` +
        'Cette action est d√©finitive. Continuer ?'
    );
    
    if (!confirmer) {
        return;
    }
    
    try {
        // D√©sactiver le bouton pendant la validation
        const btnValiderFinal = document.getElementById('btnValiderFinal');
        const texteBoutonOriginal = btnValiderFinal.innerHTML;
        btnValiderFinal.disabled = true;
        btnValiderFinal.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';
        
        // Collecter les observations actuelles directement depuis les champs
        const observations = {};
        let observationsCollectees = 0;
        
        ateliersJour.forEach(atelier => {
            if (presences[atelier.id]) {
                const textareaElement = document.getElementById(`observation_${atelier.id}`);
                if (textareaElement) {
                    const observation = textareaElement.value.trim();
                    if (observation) {
                        observations[atelier.id] = observation;
                        observationsCollectees++;
                        console.log(`üìù Observation collect√©e pour ${atelier.id}: "${observation}"`);
                    }
                }
            }
        });
        
        console.log(`üìä Total observations collect√©es: ${observationsCollectees}`);
        
        // Pr√©parer les donn√©es √† envoyer
        const donneesValidation = {
            date: dateActuelle.toISOString().split('T')[0],
            presences: presences,
            observations: observations
        };
        
        // Envoyer au serveur
        const response = await fetch('/planning/api/valider-presences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(donneesValidation)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Succ√®s avec message d√©taill√©
            let message = result.message || `${result.nombre_presences} pr√©sences valid√©es avec succ√®s !`;
            
            if (result.apprenants_ignores && result.apprenants_ignores.length > 0) {
                message += `\n\nApprenants ignor√©s (d√©j√† pr√©sents): ${result.apprenants_ignores.join(', ')}`;
            }
            
            alert(message);
            
            // IMPORTANT: Restaurer le bouton AVANT la r√©initialisation
            const btnValiderFinal = document.getElementById('btnValiderFinal');
            if (btnValiderFinal) {
                btnValiderFinal.innerHTML = '<i class="fas fa-save"></i> Valider et enregistrer';
                btnValiderFinal.disabled = true;
                btnValiderFinal.classList.remove('btn-success');
                btnValiderFinal.classList.add('btn-secondary');
            }
            
            // R√©initialiser
            presences = {};
            modificationsCount = 0;
            
            // Vider les observations
            ateliersJour.forEach(atelier => {
                const textareaElement = document.getElementById(`observation_${atelier.id}`);
                if (textareaElement) {
                    textareaElement.value = '';
                }
            });
            
            // Supprimer la sauvegarde temporaire
            localStorage.removeItem('pointage_temporaire');
            
            // Rafra√Æchir l'affichage
            afficherAteliers();
            mettreAJourStatistiques();
            mettreAJourModifications();
            
        } else {
            // Gestion des erreurs
            if (result.redirect_to_inscription) {
                // Apprenant non trouv√© - redirection vers inscription
                const confirmer = confirm(
                    result.error + '\n\n' +
                    'Voulez-vous aller √† la page d\'inscription maintenant ?'
                );
                
                if (confirmer) {
                    window.location.href = '/inscriptions';
                }
            } else {
                // Autre erreur
                alert('Erreur lors de la validation : ' + result.error);
                
                // Restaurer le bouton en cas d'erreur
                const btnValiderFinal = document.getElementById('btnValiderFinal');
                if (btnValiderFinal) {
                    btnValiderFinal.innerHTML = '<i class="fas fa-save"></i> Valider et enregistrer';
                    btnValiderFinal.disabled = modificationsCount === 0;
                    if (modificationsCount > 0) {
                        btnValiderFinal.classList.add('btn-success');
                        btnValiderFinal.classList.remove('btn-secondary');
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la validation des pr√©sences');
        
        // En cas d'erreur, restaurer le bouton original
        const btnValiderFinal = document.getElementById('btnValiderFinal');
        if (btnValiderFinal) {
            btnValiderFinal.innerHTML = '<i class="fas fa-save"></i> Valider et enregistrer';
            btnValiderFinal.disabled = modificationsCount === 0;
            if (modificationsCount > 0) {
                btnValiderFinal.classList.add('btn-success');
                btnValiderFinal.classList.remove('btn-secondary');
            }
        }
    }
    // Pas de finally block - la restauration du bouton se fait seulement en cas d'erreur
    // En cas de succ√®s, le bouton reste dans l'√©tat d√©fini par mettreAJourModifications()
}

// Fonctions utilitaires
function trouverApprenantParNumero(numero) {
    // Cette fonction devrait chercher dans la liste des apprenants
    // Pour l'instant, on retourne un objet basique
    return {
        numero: numero,
        nom_complet: `Apprenant ${numero}`
    };
}

// Liste des apprenants (√† charger depuis le backend)
const apprenants = [
    {% for apprenant in apprenants %}
    {
        numero: "{{ apprenant.numero }}",
        nom: "{{ apprenant.nom|trim }}",
        prenom: "{{ apprenant.prenom|trim }}",
        nom_complet: "{{ apprenant.nom|trim }} {{ apprenant.prenom|trim }}"  // MODIFI√â: Format NOM Pr√©nom
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Liste des classes (√† charger depuis le backend)
const classes = [
    {% for classe in classes %}
    {
        id: {{ classe.id }},
        nom: "{{ classe.nom }}",
        activite: "{{ classe.activite }}",
        encadrant: "{{ classe.encadrant }}",
        jours: {{ classe.jours|tojson }},
        heure_debut: "{{ classe.heure_debut }}",
        heure_fin: "{{ classe.heure_fin }}",
        active: {{ classe.active|lower }},
        apprenants: {{ classe.apprenants|tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Mettre √† jour la fonction pour utiliser la vraie liste
function trouverApprenantParNumero(numero) {
    const apprenant = apprenants.find(a => a.numero === numero);
    if (apprenant) {
        return {
            numero: apprenant.numero,
            nom: apprenant.nom,
            prenom: apprenant.prenom,
            nom_complet: `${apprenant.nom} ${apprenant.prenom}`.trim()  // MODIFI√â: Format NOM Pr√©nom
        };
    }
    return {
        numero: numero,
        nom_complet: `Apprenant ${numero}`
    };
}

// Variables pour la gestion d'ajout d'apprenants
let classeEnCoursAjout = null;

// Fonctions pour l'ajout d'apprenants
function ouvrirModalAjoutApprenant(atelierId, nomClasse) {
    // Trouver la classe correspondante
    classeEnCoursAjout = classes.find(c => `classe_${c.id}` === atelierId);
    
    if (!classeEnCoursAjout) {
        alert('Classe non trouv√©e');
        return;
    }
    
    document.getElementById('modalNomClasse').textContent = nomClasse;
    
    // Afficher les apprenants d√©j√† assign√©s
    afficherApprenantsAssignes();
    
    // Afficher tous les apprenants disponibles
    afficherApprenantsDisponibles();
    
    // Ouvrir le modal
    const modal = new bootstrap.Modal(document.getElementById('modalAjoutApprenant'));
    modal.show();
}

function afficherApprenantsAssignes() {
    const container = document.getElementById('listeApprenantsAssignes');
    
    if (!classeEnCoursAjout.apprenants || classeEnCoursAjout.apprenants.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle"></i> Aucun apprenant assign√© pour le moment</p>';
        return;
    }
    
    let html = '<div class="row">';
    classeEnCoursAjout.apprenants.forEach(numero => {
        const apprenant = trouverApprenantParNumero(numero);
        if (!apprenant) return;
        // G√©n√©rer vignette photo
        const numeroPhoto = numero.substring(0,6);
        let defaultPhoto = '/default_profil.jpg';
        if (apprenant.genre) {
            if (apprenant.genre.toLowerCase() === 'f') defaultPhoto = '/photos_profils_apprenants/default_femme.jpg';
            else if (apprenant.genre.toLowerCase() === 'm') defaultPhoto = '/photos_profils_apprenants/default_homme.jpg';
        }
        const photoJpg = `/photos_profils_apprenants/${numeroPhoto}.jpg`;
        const photoJpeg = `/photos_profils_apprenants/${numeroPhoto}.jpeg`;
        const photoImg = `<img src="${photoJpg}" alt="Photo de ${apprenant.nom_complet}" class="rounded-circle me-2" style="width:36px;height:36px;object-fit:cover;border:1px solid #ccc;" onerror=\"if(this.src.indexOf('.jpg')>-1){this.src='${photoJpeg}'}else{this.onerror=null;this.src='${defaultPhoto}'}\">`;
        html += `
            <div class="col-md-6 mb-2">
                <div class="d-flex align-items-center justify-content-between p-2 border rounded bg-light">
                    <span class="d-flex align-items-center">${photoImg}<strong>${numero}</strong> - ${apprenant.nom_complet}</span>
                    <button class="btn btn-outline-danger btn-sm" onclick="retirerApprenantDeClasse('${numero}')" title="Retirer de la classe">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function afficherApprenantsDisponibles(filtre = '') {
    const container = document.getElementById('listeApprenantsDisponibles');
    
    // Filtrer les apprenants d√©j√† assign√©s √† cette classe
    const apprenantsAssignes = classeEnCoursAjout.apprenants || [];
    let apprenantsDisponibles = apprenants.filter(a => !apprenantsAssignes.includes(a.numero));
    
    // Appliquer le filtre de recherche
    if (filtre) {
        const recherche = filtre.toLowerCase();
        apprenantsDisponibles = apprenantsDisponibles.filter(a => 
            a.nom_complet.toLowerCase().includes(recherche) || 
            a.numero.toLowerCase().includes(recherche)
        );
    }
    
    if (apprenantsDisponibles.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle"></i> Aucun apprenant disponible</p>';
        return;
    }
    
    // Trier : nouvelles inscriptions d'abord (num√©ros plus r√©cents)
    apprenantsDisponibles.sort((a, b) => b.numero.localeCompare(a.numero));
    
    let html = '<div class="row">';
    apprenantsDisponibles.forEach(apprenant => {
        const numeroPhoto = apprenant.numero.substring(0,6);
        let defaultPhoto = '/default_profil.jpg';
        if (apprenant.genre) {
            if (apprenant.genre.toLowerCase() === 'f') defaultPhoto = '/photos_profils_apprenants/default_femme.jpg';
            else if (apprenant.genre.toLowerCase() === 'm') defaultPhoto = '/photos_profils_apprenants/default_homme.jpg';
        }
        const photoJpg = `/photos_profils_apprenants/${numeroPhoto}.jpg`;
        const photoJpeg = `/photos_profils_apprenants/${numeroPhoto}.jpeg`;
        const photoImg = `<img src="${photoJpg}" alt="Photo de ${apprenant.nom_complet}" class="rounded-circle me-2" style="width:36px;height:36px;object-fit:cover;border:1px solid #ccc;" onerror=\"if(this.src.indexOf('.jpg')>-1){this.src='${photoJpeg}'}else{this.onerror=null;this.src='${defaultPhoto}'}\">`;
        html += `
            <div class="col-md-6 mb-2">
                <div class="d-flex align-items-center justify-content-between p-2 border rounded hover-bg-light cursor-pointer" onclick="ajouterApprenantAClasse('${apprenant.numero}')">
                    <span class="d-flex align-items-center">${photoImg}<strong>${apprenant.numero}</strong> - ${apprenant.nom_complet}</span>
                    <button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); ajouterApprenantAClasse('${apprenant.numero}')" title="Ajouter √† la classe">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function rechercherApprenantsDisponibles() {
    const filtre = document.getElementById('rechercheApprenant').value;
    afficherApprenantsDisponibles(filtre);
}

async function ajouterApprenantAClasse(numeroApprenant) {
    try {
        const response = await fetch('/planning/api/ajouter-apprenant-classe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classe_id: classeEnCoursAjout.id,
                numero_apprenant: numeroApprenant
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mettre √† jour la classe locale
            if (!classeEnCoursAjout.apprenants) {
                classeEnCoursAjout.apprenants = [];
            }
            classeEnCoursAjout.apprenants.push(numeroApprenant);
            
            // Mettre √† jour les classes globales
            const classeIndex = classes.findIndex(c => c.id === classeEnCoursAjout.id);
            if (classeIndex !== -1) {
                classes[classeIndex] = classeEnCoursAjout;
            }
            
            // Rafra√Æchir l'affichage du modal
            afficherApprenantsAssignes();
            afficherApprenantsDisponibles(document.getElementById('rechercheApprenant').value);
            
            // Rafra√Æchir l'affichage principal
            afficherAteliers();
            
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'ajout de l\'apprenant');
    }
}

async function retirerApprenantDeClasse(numeroApprenant) {
    
    try {
        const response = await fetch('/planning/api/retirer-apprenant-classe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classe_id: classeEnCoursAjout.id,
                numero_apprenant: numeroApprenant
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mettre √† jour la classe locale
            classeEnCoursAjout.apprenants = classeEnCoursAjout.apprenants.filter(num => num !== numeroApprenant);
            
            // Mettre √† jour les classes globales
            const classeIndex = classes.findIndex(c => c.id === classeEnCoursAjout.id);
            if (classeIndex !== -1) {
                classes[classeIndex] = classeEnCoursAjout;
            }
            
            // Rafra√Æchir l'affichage du modal
            afficherApprenantsAssignes();
            afficherApprenantsDisponibles(document.getElementById('rechercheApprenant').value);
            
            // Rafra√Æchir l'affichage principal
            afficherAteliers();
            
            // NOUVEAU: Garder le menu d√©pliable ouvert apr√®s la suppression
            setTimeout(() => {
                const classeId = `classe_${classeEnCoursAjout.id}`;
                const content = document.getElementById(`content_${classeId}`);
                const chevron = document.getElementById(`chevron_${classeId}`);
                const header = content?.previousElementSibling;
                
                if (content && chevron && header) {
                    content.classList.add('expanded');
                    chevron.classList.add('expanded');
                    header.classList.add('expanded');
                    console.log(`üîß Menu d√©pliable maintenu ouvert apr√®s retrait pour ${classeId}`);
                }
            }, 100);
            
            // alert('Apprenant retir√© avec succ√®s de la classe !'); // Alerte de succ√®s supprim√©e
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du retrait de l\'apprenant');
    }
}

// ========== FONCTIONS DE RECHERCHE GLOBALE D'APPRENANTS ==========

function rechercherApprenantGlobal(terme) {
    const inputElement = document.getElementById('rechercheApprenantGlobale');
    const resultatsDiv = document.getElementById('resultatsRechercheGlobale');
    const listeResultats = document.getElementById('listeResultatsGlobale');
    
    // Si le terme est vide, masquer les r√©sultats
    if (!terme || terme.trim().length < 2) {
        resultatsDiv.style.display = 'none';
        return;
    }
    
    // Rechercher dans tous les apprenants assign√©s aux classes du jour
    const resultats = [];
    const termeNormalise = terme.toLowerCase().trim();
    
    ateliersJour.forEach(atelier => {
        if (atelier.apprenants && atelier.apprenants.length > 0) {
            atelier.apprenants.forEach(numeroApprenant => {
                const apprenant = trouverApprenantParNumero(numeroApprenant);
                if (apprenant && correspondRechercheGlobale(apprenant, termeNormalise)) {
                    // V√©rifier si ce r√©sultat n'existe pas d√©j√† (au cas o√π l'apprenant serait dans plusieurs classes)
                    const existeDeja = resultats.some(r => r.apprenant.numero === apprenant.numero);
                    if (!existeDeja) {
                        resultats.push({
                            apprenant: apprenant,
                            atelier: atelier,
                            score: calculerScoreRecherche(apprenant, termeNormalise)
                        });
                    }
                }
            });
        }
    });
    
    // Trier par score de pertinence et limiter √† 8 r√©sultats
    resultats.sort((a, b) => b.score - a.score);
    const resultatsLimites = resultats.slice(0, 8);
    
    // Afficher les r√©sultats
    afficherResultatsRechercheGlobale(resultatsLimites);
}

function correspondRechercheGlobale(apprenant, terme) {
    const nom = (apprenant.nom || '').toLowerCase();
    const prenom = (apprenant.prenom || '').toLowerCase();
    const numero = (apprenant.numero || '').toLowerCase();
    const nomComplet = (apprenant.nom_complet || '').toLowerCase();
    
    return nom.includes(terme) || 
           prenom.includes(terme) || 
           numero.includes(terme) || 
           nomComplet.includes(terme);
}

function calculerScoreRecherche(apprenant, terme) {
    let score = 0;
    const nom = (apprenant.nom || '').toLowerCase();
    const prenom = (apprenant.prenom || '').toLowerCase();
    const numero = (apprenant.numero || '').toLowerCase();
    
    // Score plus √©lev√© si le terme correspond exactement
    if (nom === terme || prenom === terme) score += 100;
    if (numero === terme) score += 150;
    
    // Score moyen si le terme est au d√©but
    if (nom.startsWith(terme) || prenom.startsWith(terme)) score += 50;
    if (numero.startsWith(terme)) score += 75;
    
    // Score faible si le terme est contenu
    if (nom.includes(terme)) score += 10;
    if (prenom.includes(terme)) score += 10;
    if (numero.includes(terme)) score += 15;
    
    return score;
}

function afficherResultatsRechercheGlobale(resultats) {
    const resultatsDiv = document.getElementById('resultatsRechercheGlobale');
    const listeResultats = document.getElementById('listeResultatsGlobale');
    
    if (resultats.length === 0) {
        listeResultats.innerHTML = `
            <div class="list-group-item text-muted text-center">
                <i class="fas fa-search"></i> Aucun apprenant trouv√©
            </div>
        `;
        resultatsDiv.style.display = 'block';
        return;
    }
    
    let html = '';
    resultats.forEach(resultat => {
        const apprenant = resultat.apprenant;
        const atelier = resultat.atelier;
        
        html += `
            <div class="list-group-item list-group-item-action cursor-pointer hover-bg-light" 
                 onclick="selectionnerApprenantRecherche('${apprenant.numero}', '${atelier.id}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${apprenant.nom_complet}</h6>
                        <small class="text-muted">N¬∞ ${apprenant.numero}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info text-dark">${atelier.nom_classe || atelier.activite}</span>
                        <br><small class="text-muted">${atelier.heure_debut} - ${atelier.heure_fin}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    listeResultats.innerHTML = html;
    resultatsDiv.style.display = 'block';
}

function selectionnerApprenantRecherche(numeroApprenant, atelierId) {
    // Fermer les r√©sultats de recherche
    document.getElementById('resultatsRechercheGlobale').style.display = 'none';
    document.getElementById('rechercheApprenantGlobale').value = '';
    
    // D√©plier automatiquement la classe contenant l'apprenant
    const content = document.getElementById(`content_${atelierId}`);
    const chevron = document.getElementById(`chevron_${atelierId}`);
    const header = content.previousElementSibling;
    
    if (!content.classList.contains('expanded')) {
        content.classList.add('expanded');
        chevron.classList.add('expanded');
        header.classList.add('expanded');
    }
    
    // Attendre un court d√©lai pour que l'affichage se mette √† jour
    setTimeout(() => {
        // Trouver l'√©l√©ment de l'apprenant et le mettre en √©vidence
        const apprenantElements = document.querySelectorAll('.apprenant-item-integre');
        apprenantElements.forEach(element => {
            // V√©rifier si cet √©l√©ment correspond √† l'apprenant recherch√©
            const small = element.querySelector('small');
            if (small && small.textContent.includes(numeroApprenant)) {
                // Ajouter un effet de surbrillance temporaire
                element.style.border = '3px solid #007bff';
                element.style.backgroundColor = '#e7f3ff';
                
                // Scroll vers l'√©l√©ment
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Retirer la surbrillance apr√®s 3 secondes
                setTimeout(() => {
                    element.style.border = '';
                    element.style.backgroundColor = '';
                }, 3000);
            }
        });
    }, 500);
}

function effacerRechercheGlobale() {
    document.getElementById('rechercheApprenantGlobale').value = '';
    document.getElementById('resultatsRechercheGlobale').style.display = 'none';
}

// Ajouter un √©v√©nement pour fermer les r√©sultats si on clique ailleurs
document.addEventListener('click', function(event) {
    const searchContainer = document.getElementById('rechercheApprenantGlobale').closest('.card');
    if (!searchContainer.contains(event.target)) {
        document.getElementById('resultatsRechercheGlobale').style.display = 'none';
    }
});

// G√©rer les touches du clavier pour la navigation
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && event.key === 'f') {
        event.preventDefault();
        document.getElementById('rechercheApprenantGlobale').focus();
    }
});

// ===== FONCTIONS POUR APPRENANTS TEMPORAIRES =====

// Mettre √† jour l'aper√ßu de l'affichage nom/pr√©nom
function mettreAJourApercu() {
    const nom = document.getElementById('nomTemporaire').value.trim().toUpperCase();
    const prenom = document.getElementById('prenomTemporaire').value.trim();
    
    const apercu = document.getElementById('apercuNomPrenom');
    
    if (nom && prenom) {
        // Affichage : NOM Pr√©nom (priorit√© au nom)
        apercu.textContent = `${nom} ${prenom}`;
        apercu.className = 'text-success fw-bold';
    } else if (nom) {
        apercu.textContent = `${nom} [Pr√©nom]`;
        apercu.className = 'text-warning fw-bold';
    } else if (prenom) {
        apercu.textContent = `[NOM] ${prenom}`;
        apercu.className = 'text-warning fw-bold';
    } else {
        apercu.textContent = '[NOM Pr√©nom]';
        apercu.className = 'text-muted fw-bold';
    }
}

// Ouvrir le modal d'ajout d'apprenant temporaire
function ouvrirModalApprenantTemporaire(classeId, nomClasse) {
    classeEnCoursTemporaire = classeId;
    document.getElementById('modalClasseTemporaire').textContent = nomClasse;
    document.getElementById('nomTemporaire').value = '';
    document.getElementById('prenomTemporaire').value = '';
    
    // R√©initialiser l'aper√ßu
    mettreAJourApercu();
    
    const modal = new bootstrap.Modal(document.getElementById('modalApprenantTemporaire'));
    modal.show();
    
    // Focus sur le champ nom (priorit√© au nom)
    setTimeout(() => {
        document.getElementById('nomTemporaire').focus();
    }, 300);
}

// Ajouter un apprenant temporaire
function ajouterApprenantTemporaire() {
    const nom = document.getElementById('nomTemporaire').value.trim().toUpperCase();
    const prenom = document.getElementById('prenomTemporaire').value.trim();
    
    if (!nom || !prenom) {
        alert('Veuillez saisir le nom et le pr√©nom');
        return;
    }
    
    // V√©rifier l'unicit√© dans la m√™me classe
    if (apprenantsTemporaires[classeEnCoursTemporaire]) {
        const existe = Object.values(apprenantsTemporaires[classeEnCoursTemporaire]).some(app => 
            app.nom === nom && app.prenom.toLowerCase() === prenom.toLowerCase()
        );
        if (existe) {
            alert('Cet apprenant temporaire existe d√©j√† dans cette classe');
            return;
        }
    }
    
    // Cr√©er l'ID temporaire unique
    const tempId = `temp_${tempIdCounter++}_${Date.now()}`;
    
    // Initialiser la structure si n√©cessaire
    if (!apprenantsTemporaires[classeEnCoursTemporaire]) {
        apprenantsTemporaires[classeEnCoursTemporaire] = {};
    }
    
    // Ajouter l'apprenant temporaire
    apprenantsTemporaires[classeEnCoursTemporaire][tempId] = {
        nom: nom,
        prenom: prenom,
        statut_presence: 'present' // Marqu√© comme pr√©sent automatiquement
    };
    
    console.log(`‚ûï Apprenant temporaire ajout√©: ${prenom} ${nom} (${tempId})`);
    afficherDebugSynchronisation(`‚ûï Temp ajout√©: ${prenom} ${nom}`);
    
    // Fermer le modal
    bootstrap.Modal.getInstance(document.getElementById('modalApprenantTemporaire')).hide();
    
    // Rafra√Æchir l'affichage
    afficherAteliers();
    mettreAJourStatistiques();
    mettreAJourModifications();
    
    // NOUVEAU: Garder le menu d√©pliable ouvert apr√®s l'ajout
    setTimeout(() => {
        const content = document.getElementById(`content_${classeEnCoursTemporaire}`);
        const chevron = document.getElementById(`chevron_${classeEnCoursTemporaire}`);
        const header = content?.previousElementSibling;
        
        if (content && chevron && header) {
            content.classList.add('expanded');
            chevron.classList.add('expanded');
            header.classList.add('expanded');
            console.log(`üîß Menu d√©pliable maintenu ouvert pour ${classeEnCoursTemporaire}`);
        }
    }, 100);
    
    // Sauvegarder imm√©diatement
    sauvegarderPointageTemporaire();
}

// Supprimer un apprenant temporaire
function supprimerApprenantTemporaire(classeId, tempId) {
    const apprenant = apprenantsTemporaires[classeId]?.[tempId];
    if (!apprenant) return;
    
    const confirmer = confirm(`Supprimer l'apprenant temporaire ${apprenant.prenom} ${apprenant.nom} ?`);
    if (!confirmer) return;
    
    // Supprimer de la structure
    delete apprenantsTemporaires[classeId][tempId];
    
    // Nettoyer la structure si vide
    if (Object.keys(apprenantsTemporaires[classeId]).length === 0) {
        delete apprenantsTemporaires[classeId];
    }
    
    console.log(`‚ùå Apprenant temporaire supprim√©: ${apprenant.prenom} ${apprenant.nom}`);
    afficherDebugSynchronisation(`‚ùå Temp supprim√©: ${apprenant.prenom} ${apprenant.nom}`);
    
    // Rafra√Æchir l'affichage
    afficherAteliers();
    mettreAJourStatistiques();
    mettreAJourModifications();
    
    // NOUVEAU: Garder le menu d√©pliable ouvert apr√®s la suppression
    setTimeout(() => {
        const content = document.getElementById(`content_${classeId}`);
        const chevron = document.getElementById(`chevron_${classeId}`);
        const header = content?.previousElementSibling;
        
        if (content && chevron && header) {
            content.classList.add('expanded');
            chevron.classList.add('expanded');
            header.classList.add('expanded');
            console.log(`üîß Menu d√©pliable maintenu ouvert apr√®s suppression pour ${classeId}`);
        }
    }, 100);
    
    // Sauvegarder imm√©diatement
    sauvegarderPointageTemporaire();
}

// Rediriger vers inscription avec pr√©-remplissage
function redirigerVersInscription(tempId) {
    // Trouver l'apprenant temporaire
    let apprenantTrouve = null;
    let classeTrouvee = null;
    
    for (const [classeId, temporaires] of Object.entries(apprenantsTemporaires)) {
        if (temporaires[tempId]) {
            apprenantTrouve = temporaires[tempId];
            classeTrouvee = classeId;
            break;
        }
    }
    
    if (!apprenantTrouve) {
        alert('Apprenant temporaire non trouv√©');
        return;
    }
    
    // Sauvegarder les donn√©es temporaires avant redirection
    sauvegarderPointageTemporaire();
    
    // Construire l'URL avec param√®tres pour la page d'ajout d'inscription
    const url = `/inscriptions/inserer?nom=${encodeURIComponent(apprenantTrouve.nom)}&prenom=${encodeURIComponent(apprenantTrouve.prenom)}&retour=pointage&classe_id=${encodeURIComponent(classeTrouvee)}&temp_id=${encodeURIComponent(tempId)}`;
    
    // Confirmer la redirection
    const confirmer = confirm(
        `Rediriger vers la page d'inscription pour inscrire d√©finitivement ${apprenantTrouve.prenom} ${apprenantTrouve.nom} ?\n\n` +
        'Les champs nom et pr√©nom seront pr√©-remplis automatiquement.'
    );
    
    if (confirmer) {
        window.location.href = url;
    }
}

// Basculer pr√©sence pour temporaire (version optimis√©e)
function basculerPresenceTemporaire(classeId, tempId) {
    console.log(`üéØ Clic temporaire: ${tempId} dans ${classeId}`);
    afficherDebugSynchronisation(`üéØ Clic temp: ${tempId}`);
    
    if (!apprenantsTemporaires[classeId] || !apprenantsTemporaires[classeId][tempId]) {
        console.error('Apprenant temporaire non trouv√©');
        return;
    }
    
    const statutActuel = apprenantsTemporaires[classeId][tempId].statut_presence;
    
    // Toggle simple: pr√©sent ou undefined (non marqu√©)
    let nouveauStatut;
    if (statutActuel === 'present') {
        apprenantsTemporaires[classeId][tempId].statut_presence = undefined;
        nouveauStatut = 'pending';
        console.log(`‚ùå Temporaire ${tempId} -> non marqu√©`);
        afficherDebugSynchronisation(`‚ùå Temp ${tempId} -> non marqu√©`);
    } else {
        apprenantsTemporaires[classeId][tempId].statut_presence = 'present';
        nouveauStatut = 'present';
        console.log(`‚úÖ Temporaire ${tempId} -> pr√©sent`);
        afficherDebugSynchronisation(`‚úÖ Temp ${tempId} -> pr√©sent`);
    }
    
    // NOUVELLE APPROCHE: Mettre √† jour seulement l'√©l√©ment cliqu√©
    mettreAJourElementApprenantTemporaire(classeId, tempId, nouveauStatut);
    
    mettreAJourStatistiques();
    mettreAJourModifications();
    
    // Sauvegarder imm√©diatement
    sauvegarderPointageTemporaire();
}

// NOUVELLE FONCTION: Mettre √† jour un √©l√©ment apprenant temporaire sp√©cifique
function mettreAJourElementApprenantTemporaire(classeId, tempId, statut) {
    const element = document.querySelector(`[data-atelier-id="${classeId}"][data-temp-id="${tempId}"]`);
    if (!element) {
        console.warn(`‚ö†Ô∏è √âl√©ment apprenant temporaire non trouv√©: ${tempId} dans ${classeId}`);
        return;
    }
    
    // Supprimer les anciennes classes de statut
    element.classList.remove('present', 'absent');
    
    // Trouver l'ic√¥ne √† mettre √† jour
    const icone = element.querySelector('i[class*="fa-"]');
    
    // Appliquer le nouveau statut
    let classeStatut = '';
    let iconeClass = 'fas fa-hourglass-half text-warning';
    
    if (statut === 'present') {
        classeStatut = 'present';
        iconeClass = 'fas fa-check text-success';
    }
    
    // Mettre √† jour l'√©l√©ment
    if (classeStatut) {
        element.classList.add(classeStatut);
    }
    
    if (icone) {
        icone.className = `${iconeClass} fa-lg me-2`;
    }
    
    // Mettre √† jour les compteurs dans le header
    const presentsCount = compterPresents(classeId);
    const presentsTemporaires = compterPresentsTemporaires(classeId);
    const headerCard = document.querySelector(`[data-atelier-id="${classeId}"] .classe-header`);
    if (headerCard) {
        const badgeSuccess = headerCard.querySelector('.badge.bg-success');
        if (badgeSuccess) {
            badgeSuccess.textContent = presentsCount + presentsTemporaires;
        }
    }
    
    console.log(`üîÑ √âl√©ment temporaire mis √† jour pour ${tempId}: ${statut}`);
}

// V√©rifier s'il reste des post-it non r√©solus
function verifierPostItRestants() {
    let totalTemporaires = 0;
    
    for (const [classeId, temporaires] of Object.entries(apprenantsTemporaires)) {
        totalTemporaires += Object.keys(temporaires).length;
    }
    
    return totalTemporaires;
}

// Compter les pr√©sents temporaires pour une classe
function compterPresentsTemporaires(classeId) {
    if (!apprenantsTemporaires[classeId]) return 0;
    
    return Object.values(apprenantsTemporaires[classeId]).filter(app => 
        app.statut_presence === 'present'
    ).length;
}

</script>

{% endblock %}
